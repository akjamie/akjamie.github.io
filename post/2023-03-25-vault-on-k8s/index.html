<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <meta property="og:site_name" content="Jamie&#39;s Blog">
    <meta property="og:type" content="article">

    
    <meta property="og:image" content="http://akjamie.github.io//img/background-01.jpg">
    <meta property="twitter:image" content="http://akjamie.github.io//img/background-01.jpg" />
    

    
    <meta name="title" content="Vault on Kubernetes" />
    <meta property="og:title" content="Vault on Kubernetes" />
    <meta property="twitter:title" content="Vault on Kubernetes" />
    

    
    <meta name="description" content="To setup a HA Vault Cluster in Kubernetes">
    <meta property="og:description" content="To setup a HA Vault Cluster in Kubernetes" />
    <meta property="twitter:description" content="To setup a HA Vault Cluster in Kubernetes" />
    

    <meta property="og:url" content="http://akjamie.github.io/post/2023-03-25-vault-on-k8s/" />

    
    <meta property="twitter:card" content="summary" />
    
    

    <meta name="keyword"  content="
&#34;Jamie Zhang, blog, personal website, internet, Web, cloud native, Kubernetes, microservices, Microservice&#34;">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>Vault on Kubernetes | The curious developer&#39;s ODYSSEY</title>

    <link rel="canonical" href="/post/2023-03-25-vault-on-k8s/">

    

    
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    
    <link rel="stylesheet" href="/css/hugo-theme-cleanwhite.min.css">

    
    <link rel="stylesheet" href="/css/zanshang.min.css">

    
    <link rel="stylesheet" href="/css/font-awesome.all.min.css">

    
    
    
    

    
    <script src="/js/jquery.min.js"></script>

    
    <script src="/js/bootstrap.min.js"></script>

    
    <script src="/js/hux-blog.min.js"></script>

    
    <script src="/js/lazysizes.min.js"></script>

    
    

</head>





<nav class="navbar navbar-default navbar-custom navbar-fixed-top">

    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Jamie&#39;s Blog</a>
        </div>

        
        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">All Posts</a>
                    </li>
                    
                        
                        <li>
                            <a href="/categories/ai/">ai</a>
                        </li>
                        
                        <li>
                            <a href="/categories/cloud/">cloud</a>
                        </li>
                        
                        <li>
                            <a href="/categories/microservice/">microservice</a>
                        </li>
                        
                        <li>
                            <a href="/categories/nosql/">nosql</a>
                        </li>
                        
                        <li>
                            <a href="/categories/others/">others</a>
                        </li>
                        
                    
                    
		    
		            <li>
                        <a href="/search"><i class="fa fa-search"></i></a>
		           </li>
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    
    
    
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        
            $navbar.className = " ";
            
            setTimeout(function(){
                
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>



<header class="intro-header" style="background-image: url('/img/header-01.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 ">
                <div class="site-heading">
                    <h1>Jamie&#39;s Blog </h1>
                    
		    <span class="subheading">The curious developer&#39;s ODYSSEY, Exploring the Universe of TECH, CODE &amp; AI.</span>
                </div>
            </div>
        </div>
    </div>
</header>




<article>
    <div class="container">
        <div class="row">
            
            <div class="
            col-lg-8 col-lg-offset-1
            col-md-8 col-md-offset-1
            col-sm-12
            col-xs-12
            post-container">
            
                <h1 id="what-is-vault">What is Vault?</h1>
<h2 id="vault-introduction">Vault introduction</h2>
<p>HashiCorp Vault is an identity-based secrets and encryption management system. A secret is anything that you want to tightly<br>
control access to, such as API encryption keys, passwords, and certificates. Vault provides encryption services that are gated
by authentication and authorization methods.Using Vault’s UI, CLI, or HTTP API, access to secrets and other sensitive data
can be securely stored and managed, tightly controlled (restricted), and auditable.</p>
<p>A modern system requires access to a multitude of secrets, including database credentials, API keys for external services,
credentials for service-oriented architecture communication, etc. It can be difficult to understand who is accessing which
secrets, especially since this can be platform-specific. Adding on key rolling, secure storage, and detailed audit logs is
almost impossible without a custom solution. This is where Vault steps in.</p>
<h2 id="key-features-of-vault">Key features of Vault</h2>
<ul>
<li>Secure Secret Storage - Arbitrary key/value secrets can be stored in Vault. Vault encrypts these secrets prior to
writing them to persistent storage, so gaining access to the raw storage isn&rsquo;t enough to access your secrets.</li>
<li>Dynamic Secrets - Vault can generate secrets on-demand for some systems.</li>
<li>Data Encryption - Vault can encrypt and decrypt data without storing it.</li>
<li>Leasing and Renewal - All secrets in Vault have a lease associated with them, At the end of the lease, Vault will
automatically revoke that secret.</li>
<li>Revocation - Vault has built-in support for secret revocation. Vault can revoke not only single secrets, but a tree
of secrets.</li>
</ul>
<h1 id="why-do-we-deploy-vault-on-k8s">Why do we deploy Vault on K8s?</h1>
<p>Kubernetes has become the industry standard for container orchestration solutions, while for application level secrets<br>
management, the kubernetes Secrets are Base64 encoded strings, so there is very high risk of data leakage, it&rsquo;s
recommended to Use an external secret store provider to ensure these secrets are stored and retrieved as securely
as possible. And on bear metal machines, to deploy Vault On Kubernetes is a good alternative.</p>
<h1 id="steps-to-deploy-vault-on-k8s">Steps to deploy Vault on K8s</h1>
<h2 id="generate-vault-tls-certs">Generate Vault TLS certs</h2>
<h3 id="create-private-key">Create private key</h3>
<ol>
<li>Export working directory and naming variables.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">export</span> <span style="color:#8be9fd;font-style:italic">VAULT_K8S_NAMESPACE</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;vault&#34;</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span><span style="color:#8be9fd;font-style:italic">export</span> <span style="color:#8be9fd;font-style:italic">VAULT_HELM_RELEASE_NAME</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;vault&#34;</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span><span style="color:#8be9fd;font-style:italic">export</span> <span style="color:#8be9fd;font-style:italic">VAULT_SERVICE_NAME</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;vault-internal&#34;</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span><span style="color:#8be9fd;font-style:italic">export</span> <span style="color:#8be9fd;font-style:italic">K8S_CLUSTER_NAME</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;cluster.local&#34;</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span><span style="color:#8be9fd;font-style:italic">export</span> <span style="color:#8be9fd;font-style:italic">WORKDIR</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">$(</span><span style="color:#8be9fd;font-style:italic">pwd</span><span style="color:#ff79c6">)</span>
</span></span></code></pre></div><blockquote>
<p>root@master:/opt/k8s/config-repo/vault/pki# echo $WORKDIR<br>
/opt/k8s/config-repo/vault/pki</p>
</blockquote>
<ol start="2">
<li>Generate the private key</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>openssl genrsa -out <span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">WORKDIR</span><span style="color:#f1fa8c">}</span>/vault.key <span style="color:#bd93f9">2048</span>
</span></span><span style="display:flex;"><span>Generating RSA private key, <span style="color:#bd93f9">2048</span> bit long modulus
</span></span><span style="display:flex;"><span>....................+++
</span></span><span style="display:flex;"><span>....+++
</span></span></code></pre></div><h3 id="create-the-certificate-signing-request-csr">Create the Certificate Signing Request (CSR).</h3>
<ol>
<li>Create the CSR configuration file</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>cat &gt; ${WORKDIR}/vault-csr.conf &lt;&lt;EOF
</span></span><span style="display:flex;"><span>[req]
</span></span><span style="display:flex;"><span>default_bits = 2048
</span></span><span style="display:flex;"><span>prompt = no
</span></span><span style="display:flex;"><span>encrypt_key = yes
</span></span><span style="display:flex;"><span>default_md = sha256
</span></span><span style="display:flex;"><span>distinguished_name = kubelet_serving
</span></span><span style="display:flex;"><span>req_extensions = v3_req
</span></span><span style="display:flex;"><span>[ kubelet_serving ]
</span></span><span style="display:flex;"><span>O = system:nodes
</span></span><span style="display:flex;"><span>CN = system:node:*.${VAULT_K8S_NAMESPACE}.svc.${K8S_CLUSTER_NAME}
</span></span><span style="display:flex;"><span>[ v3_req ]
</span></span><span style="display:flex;"><span>basicConstraints = CA:FALSE
</span></span><span style="display:flex;"><span>keyUsage = nonRepudiation, digitalSignature, keyEncipherment, dataEncipherment
</span></span><span style="display:flex;"><span>extendedKeyUsage = serverAuth, clientAuth
</span></span><span style="display:flex;"><span>subjectAltName = @alt_names
</span></span><span style="display:flex;"><span>[alt_names]
</span></span><span style="display:flex;"><span>DNS.1 = *.${VAULT_SERVICE_NAME}
</span></span><span style="display:flex;"><span>DNS.2 = *.${VAULT_SERVICE_NAME}.${VAULT_K8S_NAMESPACE}.svc.${K8S_CLUSTER_NAME}
</span></span><span style="display:flex;"><span>DNS.3 = *.${VAULT_K8S_NAMESPACE}
</span></span><span style="display:flex;"><span>DNS.4 = *.it-meta.space
</span></span><span style="display:flex;"><span>DNS.5 = *.vault.svc
</span></span><span style="display:flex;"><span>IP.1 = 127.0.0.1
</span></span><span style="display:flex;"><span>IP.2 = 192.168.179.128
</span></span><span style="display:flex;"><span>EOF
</span></span></code></pre></div><blockquote>
<p>ps:<br>
DNS.4 = *.it-meta.space &ndash;&gt; This is for ingress tls proxy.<br>
DNS.5 = *.vault.svc &ndash;&gt; It seems required for vault inject agent.<br>
IP.1 = 127.0.0.1 &ndash;&gt; Local https protocol inside pod of vault.<br>
IP.2 = 192.168.179.128 &ndash;&gt; It&rsquo;s optional, just for connectivity test using curl command.</p>
</blockquote>
<ol start="2">
<li>Generate the CSR</li>
</ol>
<pre tabindex="0"><code>openssl req -new -key ${WORKDIR}/vault.key -out ${WORKDIR}/vault.csr -config ${WORKDIR}/vault-csr.conf
</code></pre><h3 id="issue-the-certificate">Issue the Certificate</h3>
<ol>
<li>Create the csr yaml file to send it to Kubernetes.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>cat &gt; ${WORKDIR}/csr.yaml &lt;&lt;EOF
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: certificates.k8s.io/v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: CertificateSigningRequest
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">name</span>: vault.svc
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">signerName</span>: kubernetes.io/kubelet-serving
</span></span><span style="display:flex;"><span>   <span style="color:#6272a4">#expirationSeconds: 8640000</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">expirationSeconds</span>: <span style="color:#bd93f9">31536000</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">request</span>: $(cat ${WORKDIR}/vault.csr|base64|tr -d &#39;\n&#39;)
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">usages</span>:
</span></span><span style="display:flex;"><span>   - digital signature
</span></span><span style="display:flex;"><span>   - key encipherment
</span></span><span style="display:flex;"><span>   - server auth
</span></span><span style="display:flex;"><span>EOF
</span></span></code></pre></div><ol start="2">
<li>Send the CSR to Kubernetes.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl create -f <span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">WORKDIR</span><span style="color:#f1fa8c">}</span>/csr.yaml
</span></span></code></pre></div><ol start="3">
<li>Approve the CSR in Kubernetes.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl certificate approve vault.svc
</span></span></code></pre></div><ol start="4">
<li>Confirm the certificate was issued.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl get csr vault.svc
</span></span><span style="display:flex;"><span>NAME        AGE   SIGNERNAME                      REQUESTOR          REQUESTEDDURATION   CONDITION
</span></span><span style="display:flex;"><span>vault.svc   75s   kubernetes.io/kubelet-serving   kubernetes-admin   365d                Approved,Issued
</span></span><span style="display:flex;"><span><span style="color:#f1fa8c">```</span>shell
</span></span><span style="display:flex;"><span><span style="color:#6272a4">### Store the certificates and Key in the Kubernetes secrets store</span>
</span></span><span style="display:flex;"><span>1. Retrieve the certificate.
</span></span><span style="display:flex;"><span><span style="color:#f1fa8c">```</span>shell
</span></span><span style="display:flex;"><span>kubectl get csr vault.svc -o <span style="color:#8be9fd;font-style:italic">jsonpath</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;{.status.certificate}&#39;</span> | openssl base64 -d -A -out <span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">WORKDIR</span><span style="color:#f1fa8c">}</span>/vault.crt
</span></span></code></pre></div><ol start="2">
<li>Retrieve Kubernetes CA certificate.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>kubectl config view \
</span></span><span style="display:flex;"><span>--raw \
</span></span><span style="display:flex;"><span>--minify \
</span></span><span style="display:flex;"><span>--flatten \
</span></span><span style="display:flex;"><span>-o jsonpath=&#39;{.clusters[].cluster.certificate-authority-data}&#39; \
</span></span><span style="display:flex;"><span>| base64 -d &gt; ${WORKDIR}/vault.ca
</span></span></code></pre></div><ol start="3">
<li>Create the Kubernetes namespace.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl create namespace <span style="color:#8be9fd;font-style:italic">$VAULT_K8S_NAMESPACE</span>
</span></span></code></pre></div><ol start="4">
<li>Create the TLS secret.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl create secret generic vault-ha-tls <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>   -n <span style="color:#8be9fd;font-style:italic">$VAULT_K8S_NAMESPACE</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>   --from-file<span style="color:#ff79c6">=</span>vault.key<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">WORKDIR</span><span style="color:#f1fa8c">}</span>/vault.key <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>   --from-file<span style="color:#ff79c6">=</span>vault.crt<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">WORKDIR</span><span style="color:#f1fa8c">}</span>/vault.crt <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>   --from-file<span style="color:#ff79c6">=</span>vault.ca<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">WORKDIR</span><span style="color:#f1fa8c">}</span>/vault.ca
</span></span></code></pre></div><h2 id="deploy-the-vault-cluster-via-helm-with-overrides">Deploy the vault cluster via helm with overrides</h2>
<h3 id="prerequisites">Prerequisites</h3>
<p>Please ensure the Vault CLI, Helm CLI are installed before proceed consequent steps.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@master:/opt/k8s/config-repo/vault/pki# helm version
</span></span><span style="display:flex;"><span>version.BuildInfo<span style="color:#ff79c6">{</span>Version:<span style="color:#f1fa8c">&#34;v3.10.2&#34;</span>, GitCommit:<span style="color:#f1fa8c">&#34;50f003e5ee8704ec937a756c646870227d7c8b58&#34;</span>, GitTreeState:<span style="color:#f1fa8c">&#34;clean&#34;</span>, GoVersion:<span style="color:#f1fa8c">&#34;go1.18.8&#34;</span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>root@master:/opt/k8s/config-repo/vault/pki# vault -v
</span></span><span style="display:flex;"><span>Vault v1.13.0 <span style="color:#ff79c6">(</span>a4cf0dc4437de35fce4860857b64569d092a9b5a<span style="color:#ff79c6">)</span>, built 2023-03-01T14:58:13Z
</span></span></code></pre></div><h3 id="deploy-ha-cluster-via-helm">Deploy HA cluster via Helm</h3>
<ol>
<li>create the overrides.yaml file.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>cat &gt; ${WORKDIR}/overrides.yaml &lt;&lt;EOF
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">global</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">enabled</span>: <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">tlsDisable</span>: <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">injector</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">enabled</span>: <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">resources</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">requests</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">memory</span>: 256Mi
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">cpu</span>: 250m
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">limits</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">memory</span>: 256Mi
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">cpu</span>: 250m
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">server</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">resources</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">requests</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">memory</span>: 256Mi
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">cpu</span>: 200m
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">limits</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">memory</span>: 384Mi
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">cpu</span>: 200m
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">extraEnvironmentVars</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">VAULT_CACERT</span>: /vault/userconfig/vault-ha-tls/vault.ca
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">VAULT_TLSCERT</span>: /vault/userconfig/vault-ha-tls/vault.crt
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">VAULT_TLSKEY</span>: /vault/userconfig/vault-ha-tls/vault.key
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">volumes</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">name</span>: userconfig-vault-ha-tls
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">secret</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">defaultMode</span>: <span style="color:#bd93f9">420</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">secretName</span>: vault-ha-tls
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">volumeMounts</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">mountPath</span>: /vault/userconfig/vault-ha-tls
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">name</span>: userconfig-vault-ha-tls
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">readOnly</span>: <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">auditStorage</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">enabled</span>: <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">standalone</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">enabled</span>: <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">standalone</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">enabled</span>: <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">affinity</span>: <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">ha</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">enabled</span>: <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">replicas</span>: <span style="color:#bd93f9">2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">raft</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">enabled</span>: <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">setNodeId</span>: <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">config</span>: |<span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        ui = true
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        listener &#34;tcp&#34; {
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">           tls_disable = 0
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">           address = &#34;[::]:8200&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">           cluster_address = &#34;[::]:8201&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">           tls_cert_file = &#34;/vault/userconfig/vault-ha-tls/vault.crt&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">           tls_key_file  = &#34;/vault/userconfig/vault-ha-tls/vault.key&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">           tls_client_ca_file = &#34;/vault/userconfig/vault-ha-tls/vault.ca&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        }
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        storage &#34;raft&#34; {
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">           path = &#34;/vault/data&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        }
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        disable_mlock = true
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        service_registration &#34;kubernetes&#34; {}</span>
</span></span><span style="display:flex;"><span>EOF
</span></span></code></pre></div><ol start="2">
<li>Deploy the Vault HA Cluster</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>helm install -n <span style="color:#8be9fd;font-style:italic">$VAULT_K8S_NAMESPACE</span> <span style="color:#8be9fd;font-style:italic">$VAULT_HELM_RELEASE_NAME</span> hashicorp/vault -f <span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">WORKDIR</span><span style="color:#f1fa8c">}</span>/overrides.yaml
</span></span></code></pre></div><ol start="3">
<li>Display the pods in the namespace that you created for vault.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@master:/opt/k8s/config-repo/vault# kubectl -n <span style="color:#8be9fd;font-style:italic">$VAULT_K8S_NAMESPACE</span> get pods
</span></span><span style="display:flex;"><span>NAME                                    READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>vault-0                                 0/1     Running   <span style="color:#bd93f9">0</span>          28s
</span></span><span style="display:flex;"><span>vault-1                                 0/1     Running   <span style="color:#bd93f9">0</span>          27s
</span></span><span style="display:flex;"><span>vault-agent-injector-57bfcf947c-2p6ws   1/1     Running   <span style="color:#bd93f9">0</span>          38s
</span></span></code></pre></div><ol start="4">
<li>Initialize vault-0 with one key share and one key threshold.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl <span style="color:#8be9fd;font-style:italic">exec</span> -n <span style="color:#8be9fd;font-style:italic">$VAULT_K8S_NAMESPACE</span> vault-0 -- vault operator init <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    -key-shares<span style="color:#ff79c6">=</span><span style="color:#bd93f9">5</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    -key-threshold<span style="color:#ff79c6">=</span><span style="color:#bd93f9">2</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    -format<span style="color:#ff79c6">=</span>json &gt; <span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">WORKDIR</span><span style="color:#f1fa8c">}</span>/cluster-keys.json
</span></span></code></pre></div><blockquote>
<p>PS:</p>
<ol>
<li>The operator init command generates a root key that it disassembles into key shares -key-shares=5 and then sets the
number of key shares required to unseal Vault -key-threshold=2.</li>
<li>For production HA, better to set the key-shares &amp; key-threshold bit larger than 1 to fit for your security needs.
I will set the key-shares as 5 and key-threshold=2 for later demo.
<img src='/img/2023-03-25-vault-on-k8s/vault-init-01.jpg' style="height: 420px;margin-left: 0px;"/></li>
</ol>
</blockquote>
<ol start="5">
<li>Create a variable named VAULT_UNSEAL_KEY to capture the Vault unseal key<br>
randomly pick up two from these 5 shares.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">export</span> <span style="color:#8be9fd;font-style:italic">VAULT_UNSEAL_KEY_1</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;+BLXCXRatpd5uiamYAly5vfea1eRBOOP8jrRpTxEOzTT&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">export</span> <span style="color:#8be9fd;font-style:italic">VAULT_UNSEAL_KEY_2</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;K8lYi9kLRA9nQ2KrV0qWvKMjvIREDroJOP7q2OWscljL&#34;</span> 
</span></span></code></pre></div><ol start="6">
<li>Unseal Vault running on the vault-0 pod.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl <span style="color:#8be9fd;font-style:italic">exec</span> -n <span style="color:#8be9fd;font-style:italic">$VAULT_K8S_NAMESPACE</span> vault-0 -- vault operator unseal <span style="color:#8be9fd;font-style:italic">$VAULT_UNSEAL_KEY_1</span>
</span></span><span style="display:flex;"><span>kubectl <span style="color:#8be9fd;font-style:italic">exec</span> -n <span style="color:#8be9fd;font-style:italic">$VAULT_K8S_NAMESPACE</span> vault-0 -- vault operator unseal <span style="color:#8be9fd;font-style:italic">$VAULT_UNSEAL_KEY_2</span>
</span></span></code></pre></div><h3 id="join-vault-1-pod-to-the-raft-cluster">Join vault-1 pod to the Raft cluster</h3>
<ol>
<li>Start an interactive shell session on the vault-1 pod.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl <span style="color:#8be9fd;font-style:italic">exec</span> -n <span style="color:#8be9fd;font-style:italic">$VAULT_K8S_NAMESPACE</span> -it vault-1 -- /bin/sh
</span></span></code></pre></div><ol start="2">
<li>Join the vault-1 pod to the Raft cluster.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>vault operator raft join -address<span style="color:#ff79c6">=</span>https://vault-1.vault-internal:8200 -leader-ca-cert<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;</span><span style="color:#ff79c6">$(</span>cat /vault/userconfig/vault-ha-tls/vault.ca<span style="color:#ff79c6">)</span><span style="color:#f1fa8c">&#34;</span> -leader-client-cert<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;</span><span style="color:#ff79c6">$(</span>cat /vault/userconfig/vault-ha-tls/vault.crt<span style="color:#ff79c6">)</span><span style="color:#f1fa8c">&#34;</span> -leader-client-key<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;</span><span style="color:#ff79c6">$(</span>cat /vault/userconfig/vault-ha-tls/vault.key<span style="color:#ff79c6">)</span><span style="color:#f1fa8c">&#34;</span> https://vault-0.vault-internal:8200
</span></span></code></pre></div><p>Example output:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>Key       Value
</span></span><span style="display:flex;"><span>---       -----
</span></span><span style="display:flex;"><span>Joined    <span style="color:#8be9fd;font-style:italic">true</span>
</span></span></code></pre></div><p>Once success, then exit the vault-1 pod.
3. Unseal vault-1.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl <span style="color:#8be9fd;font-style:italic">exec</span> -n <span style="color:#8be9fd;font-style:italic">$VAULT_K8S_NAMESPACE</span> -ti vault-1 -- vault operator unseal <span style="color:#8be9fd;font-style:italic">$VAULT_UNSEAL_KEY_1</span>
</span></span><span style="display:flex;"><span>kubectl <span style="color:#8be9fd;font-style:italic">exec</span> -n <span style="color:#8be9fd;font-style:italic">$VAULT_K8S_NAMESPACE</span> -ti vault-1 -- vault operator unseal <span style="color:#8be9fd;font-style:italic">$VAULT_UNSEAL_KEY_2</span>
</span></span></code></pre></div><p>Example output:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>Key                Value
</span></span><span style="display:flex;"><span>---                -----
</span></span><span style="display:flex;"><span>Seal Type          shamir
</span></span><span style="display:flex;"><span>Initialized        <span style="color:#8be9fd;font-style:italic">true</span>
</span></span><span style="display:flex;"><span>Sealed             <span style="color:#8be9fd;font-style:italic">true</span>
</span></span><span style="display:flex;"><span>Total Shares       <span style="color:#bd93f9">5</span>
</span></span><span style="display:flex;"><span>Threshold          <span style="color:#bd93f9">2</span>
</span></span><span style="display:flex;"><span>Unseal Progress    0/2
</span></span><span style="display:flex;"><span>Unseal Nonce       n/a
</span></span><span style="display:flex;"><span>Version            1.12.1
</span></span><span style="display:flex;"><span>Build Date         2022-10-27T12:32:05Z
</span></span><span style="display:flex;"><span>Storage Type       raft
</span></span><span style="display:flex;"><span>HA Enabled         <span style="color:#8be9fd;font-style:italic">true</span>
</span></span></code></pre></div><ol start="4">
<li>Export the cluster root token.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">export</span> <span style="color:#8be9fd;font-style:italic">CLUSTER_ROOT_TOKEN</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">$(</span>cat <span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">WORKDIR</span><span style="color:#f1fa8c">}</span>/cluster-keys.json | jq -r <span style="color:#f1fa8c">&#34;.root_token&#34;</span><span style="color:#ff79c6">)</span>
</span></span></code></pre></div><ol start="5">
<li>Login to vault-0 with the root token.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@master:/opt/k8s/config-repo/vault/pki# kubectl <span style="color:#8be9fd;font-style:italic">exec</span> -n <span style="color:#8be9fd;font-style:italic">$VAULT_K8S_NAMESPACE</span> vault-0 -- vault login <span style="color:#8be9fd;font-style:italic">$CLUSTER_ROOT_TOKEN</span>
</span></span><span style="display:flex;"><span>Success! You are now authenticated. The token information displayed below
</span></span><span style="display:flex;"><span>is already stored in the token helper. You <span style="color:#ff79c6">do</span> NOT need to run <span style="color:#f1fa8c">&#34;vault login&#34;</span>
</span></span><span style="display:flex;"><span>again. Future Vault requests will automatically use this token.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Key                  Value
</span></span><span style="display:flex;"><span>---                  -----
</span></span><span style="display:flex;"><span>token                hvs.oemGqKix23q5FMi6qkXiLsqN
</span></span><span style="display:flex;"><span>token_accessor       BVDmPTEBLgdxLEvQs4p5bXaD
</span></span><span style="display:flex;"><span>token_duration       ∞
</span></span><span style="display:flex;"><span>token_renewable      <span style="color:#8be9fd;font-style:italic">false</span>
</span></span><span style="display:flex;"><span>token_policies       <span style="color:#ff79c6">[</span><span style="color:#f1fa8c">&#34;root&#34;</span><span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>identity_policies    <span style="color:#ff79c6">[]</span>
</span></span><span style="display:flex;"><span>policies             <span style="color:#ff79c6">[</span><span style="color:#f1fa8c">&#34;root&#34;</span><span style="color:#ff79c6">]</span>
</span></span></code></pre></div><ol start="6">
<li>List the raft peers.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@master:/opt/k8s/config-repo/vault/pki# kubectl <span style="color:#8be9fd;font-style:italic">exec</span> -n <span style="color:#8be9fd;font-style:italic">$VAULT_K8S_NAMESPACE</span> vault-0 -- vault operator raft list-peers
</span></span><span style="display:flex;"><span>Node       Address                        State       Voter
</span></span><span style="display:flex;"><span>----       -------                        -----       -----
</span></span><span style="display:flex;"><span>vault-0    vault-0.vault-internal:8201    leader      <span style="color:#8be9fd;font-style:italic">true</span>
</span></span><span style="display:flex;"><span>vault-1    vault-1.vault-internal:8201    follower    <span style="color:#8be9fd;font-style:italic">true</span>
</span></span></code></pre></div><ol start="7">
<li>Print the HA status</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@master:/opt/k8s/config-repo/vault/pki# kubectl <span style="color:#8be9fd;font-style:italic">exec</span> -n <span style="color:#8be9fd;font-style:italic">$VAULT_K8S_NAMESPACE</span> vault-0 -- vault status
</span></span><span style="display:flex;"><span>Key                     Value
</span></span><span style="display:flex;"><span>---                     -----
</span></span><span style="display:flex;"><span>Seal Type               shamir
</span></span><span style="display:flex;"><span>Initialized             <span style="color:#8be9fd;font-style:italic">true</span>
</span></span><span style="display:flex;"><span>Sealed                  <span style="color:#8be9fd;font-style:italic">false</span>
</span></span><span style="display:flex;"><span>Total Shares            <span style="color:#bd93f9">5</span>
</span></span><span style="display:flex;"><span>Threshold               <span style="color:#bd93f9">2</span>
</span></span><span style="display:flex;"><span>Version                 1.12.1
</span></span><span style="display:flex;"><span>Build Date              2022-10-27T12:32:05Z
</span></span><span style="display:flex;"><span>Storage Type            raft
</span></span><span style="display:flex;"><span>Cluster Name            vault-cluster-1ff6c3b7
</span></span><span style="display:flex;"><span>Cluster ID              989f282b-a491-6acb-7ad2-24401d96ff0c
</span></span><span style="display:flex;"><span>HA Enabled              <span style="color:#8be9fd;font-style:italic">true</span>
</span></span><span style="display:flex;"><span>HA Cluster              https://vault-0.vault-internal:8201
</span></span><span style="display:flex;"><span>HA Mode                 active
</span></span><span style="display:flex;"><span>Active Since            2023-03-26T05:15:13.133233643Z
</span></span><span style="display:flex;"><span>Raft Committed Index    <span style="color:#bd93f9">40</span>
</span></span><span style="display:flex;"><span>Raft Applied Index      <span style="color:#bd93f9">40</span>
</span></span></code></pre></div><p>We now have a working 2 node cluster with TLS enabled at the pod level. Next we will create a secret and retrieve it via
and API call to confirm TLS is working as expected.</p>
<h3 id="create-ingress-to-expose-the-vault-uinot-recommend-on-production">Create ingress to expose the Vault UI(not recommend on Production)</h3>
<ol>
<li>Prepare TLS - request free cert on AliCloud.
Here i got 1 free cert pair for my domain <strong>vault.it-meta.space</strong></li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@master:/opt/k8s/config-repo/vault# ls -al | grep it-meta.space
</span></span><span style="display:flex;"><span>-rwxrwxrwx <span style="color:#bd93f9">1</span> jamie jamie <span style="color:#bd93f9">1679</span> Mar <span style="color:#bd93f9">14</span> 14:54 9482518_vault.it-meta.space.key
</span></span><span style="display:flex;"><span>-rwxrwxrwx <span style="color:#bd93f9">1</span> jamie jamie <span style="color:#bd93f9">3813</span> Mar <span style="color:#bd93f9">14</span> 14:54 9482518_vault.it-meta.space.pem
</span></span></code></pre></div><ol start="2">
<li>Create Secret tls from these two cert files</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>k create secret tls vault-ext-tls --cert<span style="color:#ff79c6">=</span>./9482518_vault.it-meta.space.pem --key<span style="color:#ff79c6">=</span>./9482518_vault.it-meta.space.key -n vault
</span></span></code></pre></div><ol start="3">
<li>Create ingress for vault UI</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>cat &gt; ${WORKDIR}/vault-ingress.yaml &lt;&lt;EOF
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: networking.k8s.io/v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Ingress
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: vault-ingress
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: vault
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">annotations</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">nginx.ingress.kubernetes.io/use-regex</span>: <span style="color:#f1fa8c">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">nginx.ingress.kubernetes.io/rewrite-target</span>: /$1
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">nginx.ingress.kubernetes.io/ssl-redirect</span>: <span style="color:#f1fa8c">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">nginx.ingress.kubernetes.io/backend-protocol</span>: <span style="color:#f1fa8c">&#34;HTTPS&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">ingressClassName</span>: nginx
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">rules</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">host</span>: vault.it-meta.space
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">http</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">paths</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#ff79c6">path</span>: /(.*)
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">pathType</span>: Prefix
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">backend</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">service</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">name</span>: vault
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">port</span>:
</span></span><span style="display:flex;"><span>                  <span style="color:#ff79c6">number</span>: <span style="color:#bd93f9">8200</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">tls</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">secretName</span>: vault-ext-tls
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">hosts</span>:
</span></span><span style="display:flex;"><span>        - vault.it-meta.space
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>k apply -f ${WORKDIR}/vault-ingress.yaml
</span></span></code></pre></div><ol start="4">
<li>Verify the ingress.
<img src='/img/2023-03-25-vault-on-k8s/vault-ui-01.jpg' style="height: 300px;margin-left: 0px;"/></li>
</ol>
<p>Use root token to login
<img src='/img/2023-03-25-vault-on-k8s/vault-ui-02.jpg' style="height: 240px;margin-left: 0px;"/></p>
<h1 id="continue">Continue</h1>
<p>Ends here, will continue the kubernetes engine enablement and vault inject agent in next blog.</p>
<p>Reference docs:<br>
<a href="https://developer.hashicorp.com/vault/tutorials/kubernetes/kubernetes-minikube-tls">https://developer.hashicorp.com/vault/tutorials/kubernetes/kubernetes-minikube-tls</a></p>

            
             
            




            
            </div>
            
            

<div class="
    col-lg-3 col-lg-offset-0
    col-md-3 col-md-offset-0
    col-sm-12
    col-xs-12
    sidebar-container
">
    
	
    <section class="visible-md visible-lg">
	
        <div class="short-about">
            
            <a href="/about">
               <img src="/img/20190713213835-3.jpg" alt="avatar" style="cursor: pointer" />
            </a>
            
            
                <p>Senior Software Engineer, Open source enthusiast, PMP, Scrum master</p>
            
           
           <ul class="list-inline">
               
               <li>
                   <a href="mailto:akjamie.zhang@outlook.com">
                      <span class="fa-stack fa-lg">
                          <i class="fa fa-circle fa-stack-2x"></i>
                          <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                      </span>
                   </a>
               </li>
               
               
               
               
               
               
               <li>
                   <a target="_blank" href="/img/wechat-qrcode.png">
                       <span class="fa-stack fa-lg">
                           <i class="fas fa-circle fa-stack-2x"></i>
                           <i class="fab fa-weixin fa-stack-1x fa-inverse"></i>
                       </span>
                   </a>
               </li>
               
               
               <li>
                   <a target="_blank" href="https://github.com/akjamie">
                       <span class="fa-stack fa-lg">
                           <i class="fas fa-circle fa-stack-2x"></i>
                           <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                       </span>
                   </a>
               </li>
               
               
               
               
               <li>
                   <a target="_blank" href="https://www.linkedin.com/in/jamie-zhang">
                       <span class="fa-stack fa-lg">
                           <i class="fas fa-circle fa-stack-2x"></i>
                           <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                       </span>
                   </a>
               </li>
               
               
               
            
            
               
               
               
               
                </ul>
            </div>
    </section>
	
    
    
    
    
    <section>
        <hr class="hidden-sm hidden-xs">
        <h5>FEATURED TAGS</h5>
        <div class="tags">
            
            
               
            
               
            
               
            
               
                    <a href="/tags/aws" title="aws">
                        aws
                    </a>
               
            
               
            
               
            
               
            
               
            
               
            
               
            
               
            
               
                    <a href="/tags/docker" title="docker">
                        docker
                    </a>
               
            
               
            
               
            
               
            
               
            
               
            
               
                    <a href="/tags/k8s" title="k8s">
                        k8s
                    </a>
               
            
               
                    <a href="/tags/kubernetes" title="kubernetes">
                        kubernetes
                    </a>
               
            
               
            
               
            
               
                    <a href="/tags/llm" title="llm">
                        llm
                    </a>
               
            
               
            
               
            
               
            
               
            
               
                    <a href="/tags/nosql" title="nosql">
                        nosql
                    </a>
               
            
               
            
               
                    <a href="/tags/python" title="python">
                        python
                    </a>
               
            
               
                    <a href="/tags/redis" title="redis">
                        redis
                    </a>
               
            
               
            
               
            
               
                    <a href="/tags/spring" title="spring">
                        spring
                    </a>
               
            
               
            
               
            
               
                    <a href="/tags/spring-cloud" title="spring cloud">
                        spring cloud
                    </a>
               
            
               
            
               
            
               
                    <a href="/tags/transaction-management" title="transaction management">
                        transaction management
                    </a>
               
            
               
                    <a href="/tags/transformer" title="transformer">
                        transformer
                    </a>
               
            
               
            
               
                    <a href="/tags/vault" title="vault">
                        vault
                    </a>
               
            
               
            
        </div>
    </section>
    

    
    
    <section>
        <hr class="hidden-sm hidden-xs">
        <h5>FRIENDS</h5>
        <ul class="list-inline">
            
        </ul>
    </section>
    
    
    
</div>

        </div>
    </div>
</article>




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    
                    <li>
                        <a href="mailto:akjamie.zhang@outlook.com">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		           
                    
                    
                    
                    

		            
                    
                    <li>
                        <a target="_blank" href="/img/wechat-qrcode.png">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-weixin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		            
                    
                    <li>
                        <a target="_blank" href="https://github.com/akjamie">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		            
                    
                    
                    
                    <li>
                        <a target="_blank" href="https://www.linkedin.com/in/jamie-zhang">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		           
                    
                    
                    
                    
                    
                    
            
            
            
           
                   <li>
                       <a href='' rel="alternate" type="application/rss+xml" title="Jamie&#39;s Blog" >
                           <span class="fa-stack fa-lg">
                               <i class="fas fa-circle fa-stack-2x"></i>
                               <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
                           </span>
                       </a>
                   </li>
            
             </ul>
		<p class="copyright text-muted">
                    Copyright &copy; Jamie&#39;s Blog 2025
                    
                </p>
            </div>
        </div>
    </div>
</footer>




<script>
    function loadAsync(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>






<script>
    
    if($('#tag_cloud').length !== 0){
        loadAsync("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script>
    loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>






<script type="text/javascript">
    function generateCatalog(selector) {

        
        
        
        
            _containerSelector = 'div.post-container'
        

        
        var P = $(_containerSelector), a, n, t, l, i, c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        
        $(selector).html('')

        
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#" + $(this).prop('id');
            t = $(this).text();
            c = $('<a href="' + i + '" rel="nofollow" title="' + t + '">' + t + '</a>');
            l = $('<li class="' + n + '_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    
    $(".catalog-toggle").click((function (e) {
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    


    loadAsync("\/js\/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>







</body>
</html>
