<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <meta property="og:site_name" content="Jamie&#39;s Blog">
    <meta property="og:type" content="article">

    
    <meta property="og:image" content="http://akjamie.github.io//img/background-01.jpg">
    <meta property="twitter:image" content="http://akjamie.github.io//img/background-01.jpg" />
    

    
    <meta name="title" content="Vault Agent with Kubernetes" />
    <meta property="og:title" content="Vault Agent with Kubernetes" />
    <meta property="twitter:title" content="Vault Agent with Kubernetes" />
    

    
    <meta name="description" content="Nearly all requests to Vault must be accompanied by an authentication token. This includes all API requests, as well as via the Vault CLI and other libraries, therefore application running in kubernetes is no exception. Luckily, Vault provides Kubernetes auth method to authenticate the clients using a Kubernetes Service Account Token, and Vault Agent which could be leveraged to automatically inject the secrets from vault into kubernetes pods through init container pattern.">
    <meta property="og:description" content="Nearly all requests to Vault must be accompanied by an authentication token. This includes all API requests, as well as via the Vault CLI and other libraries, therefore application running in kubernetes is no exception. Luckily, Vault provides Kubernetes auth method to authenticate the clients using a Kubernetes Service Account Token, and Vault Agent which could be leveraged to automatically inject the secrets from vault into kubernetes pods through init container pattern." />
    <meta property="twitter:description" content="Nearly all requests to Vault must be accompanied by an authentication token. This includes all API requests, as well as via the Vault CLI and other libraries, therefore application running in kubernetes is no exception. Luckily, Vault provides Kubernetes auth method to authenticate the clients using a Kubernetes Service Account Token, and Vault Agent which could be leveraged to automatically inject the secrets from vault into kubernetes pods through init container pattern." />
    

    <meta property="og:url" content="http://akjamie.github.io/post/2023-03-26-vault-agent-with-k8s/" />

    
    <meta property="twitter:card" content="summary" />
    
    

    <meta name="keyword"  content="
&#34;Jamie Zhang, blog, personal website, internet, Web, cloud native, Kubernetes, microservices, Microservice&#34;">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>Vault Agent with Kubernetes | The curious developer&#39;s ODYSSEY</title>

    <link rel="canonical" href="/post/2023-03-26-vault-agent-with-k8s/">

    

    
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    
    <link rel="stylesheet" href="/css/hugo-theme-cleanwhite.min.css">

    
    <link rel="stylesheet" href="/css/zanshang.min.css">

    
    <link rel="stylesheet" href="/css/font-awesome.all.min.css">

    
    
    
    

    
    <script src="/js/jquery.min.js"></script>

    
    <script src="/js/bootstrap.min.js"></script>

    
    <script src="/js/hux-blog.min.js"></script>

    
    <script src="/js/lazysizes.min.js"></script>

    
    

</head>





<nav class="navbar navbar-default navbar-custom navbar-fixed-top">

    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Jamie&#39;s Blog</a>
        </div>

        
        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">All Posts</a>
                    </li>
                    
                        
                        <li>
                            <a href="/categories/ai/">ai</a>
                        </li>
                        
                        <li>
                            <a href="/categories/cloud/">cloud</a>
                        </li>
                        
                        <li>
                            <a href="/categories/microservice/">microservice</a>
                        </li>
                        
                        <li>
                            <a href="/categories/nosql/">nosql</a>
                        </li>
                        
                        <li>
                            <a href="/categories/others/">others</a>
                        </li>
                        
                    
                    
		    
		            <li>
                        <a href="/search"><i class="fa fa-search"></i></a>
		           </li>
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    
    
    
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        
            $navbar.className = " ";
            
            setTimeout(function(){
                
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>




<style type="text/css">
    header.intro-header {
        background-image: url('/img/background-01.jpg')
    }
</style>

<header class="intro-header" >

    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/vault" title="Vault">
                            Vault
                        </a>
                        
                        <a class="tag" href="/tags/kubernetes" title="Kubernetes">
                            Kubernetes
                        </a>
                        
                    </div>
                    <h1>Vault Agent with Kubernetes</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        
                            Posted by 
                            
                                Jamie
                             
                            on 
                            Sunday, March 26, 2023
                            
                                <span id="/post/2023-03-26-vault-agent-with-k8s/" class="leancloud_visitors meta_data_item" data-flag-title="">
    <span class="post-meta-item-icon">
      <span class="octicon octicon-eye"></span> 
    </span>
    <i class="fa fa-eye"></i>
    <span class="old-visitors-count" style="display: none;"></span>
    <span class="leancloud-visitors-count"></span>
</span>



<script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>

<script>
	AV.initialize("xPw359Vqc2mJIQwyn3kk1tr6-MdYXbMMI", "oWnYnSQrRigb5tOZHi4rcIGO");
</script>

<script type="text/javascript">
function showTime(Counter) {
    var query = new AV.Query(Counter);
    var entries = [];
    var $visitors = $(".leancloud_visitors");

    $visitors.each(function() {
        entries.push($(this).attr("id").trim());
    });

    query.containedIn('url', entries);
    query.find()
        .done(function(results) {
            var COUNT_CONTAINER_REF = '.leancloud-visitors-count';
            var OLD_COUNT_CONTAINER_REF = '.old-visitors-count';

            
            
            
            

            for (var i = 0; i < results.length; i++) {
                var item = results[i];
                var url = item.get('url');
                var time = item.get('time');
                var element = document.getElementById(url);

                $(element).find(COUNT_CONTAINER_REF).text(time);
            }
            for (var i = 0; i < entries.length; i++) {
                var url = entries[i];
                var element = document.getElementById(url);
                var countSpan = $(element).find(COUNT_CONTAINER_REF);
                if (countSpan.text() == '') {
                    var oldCountSpan = $(element).find(OLD_COUNT_CONTAINER_REF).text();
                    if(oldCountSpan!=''){
                        countSpan.text(0+parseInt(oldCountSpan));
                    }else{
                        countSpan.text(0);          
                    }
                }
            }
        })
        .fail(function(object, error) {
            console.log("Error: " + error.code + " " + error.message);
        });
}

function addCount(Counter) {
    var $visitors = $(".leancloud_visitors");
    var url = $visitors.attr('id').trim();
    var title = $visitors.attr('data-flag-title').trim();
    var query = new AV.Query(Counter);

    query.equalTo("url", url);
    query.find({
        success: function(results) {
            if (results.length > 0) {
                var counter = results[0];
                counter.fetchWhenSave(true);
                counter.increment("time");
                counter.save(null, {
                    success: function(counter) {
                        var $element = $(document.getElementById(url));
                        $element.find('.leancloud-visitors-count').text(counter.get('time'));
                    },
                    error: function(counter, error) {
                        console.log('Failed to save Visitor num, with error message: ' + error.message);
                    }
                });
            } else {
                var newcounter = new Counter();
                 
                var acl = new AV.ACL();
                acl.setPublicReadAccess(true);
                acl.setPublicWriteAccess(true);
                newcounter.setACL(acl);
                 
                newcounter.set("title", title);
                newcounter.set("url", url);
                var OLD_COUNT_CONTAINER_REF = '.old-visitors-count';
                var $element = $(document.getElementById(url));
                var oldCountSpan = $element.find(OLD_COUNT_CONTAINER_REF).text();
                if(oldCountSpan!=''){
                    newcounter.set("time", parseInt(oldCountSpan)+1);
                }else{
 	                    newcounter.set("time",  1);
                }
                newcounter.save(null, {
                    success: function(newcounter) {
                        var $element = $(document.getElementById(url));
                        $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
                    },
                    error: function(newcounter, error) {
                        console.log('Failed to create');
                    }
                });
            }
        },
        error: function(error) {
            console.log('Error:' + error.code + " " + error.message);
        }
    });
}
$(function() {
    var Counter = AV.Object.extend("Counter");
    
    
    if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
    } else {
        showTime(Counter);
    }
});
</script>

                            
                            
                            
                            
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>




<article>
    <div class="container">
        <div class="row">

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                
                <h1 id="challenge">Challenge</h1>
<p>Nearly all requests to Vault must be accompanied by an authentication token. This includes all API requests, as well as
via the Vault CLI and other libraries. If you can securely get the first secret from an originator to a consumer,
all subsequent secrets transmitted between this originator and consumer can be authenticated with the trust
established by the successful distribution and user of that first secret.</p>
<p>The applications running in a Kubernetes environment is no exception. Luckily, Vault provides Kubernetes auth method to
authenticate the clients using a Kubernetes Service Account Token.</p>
<p>However, Client is still responsible for managing the lifecycle of its Vault Tokens as illustrated on below diagram of
Vault Workflow on kubernetes.
<img src='/img/2023-03-26-vault-agent-with-k8s/vault-k8s-workflow-01.png' style="height: 840px;margin-left: 0px;"/></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-markdown" data-lang="markdown"><span style="display:flex;"><span>Major processes:
</span></span><span style="display:flex;"><span> <span style="color:#ff79c6">-</span> One-off setup/infrequent action for initial configuration &amp; standard policy maintenance, e.g. enable auth method,  
</span></span><span style="display:flex;"><span>create roles,policies.
</span></span><span style="display:flex;"><span> <span style="color:#ff79c6">-</span> Pod deployed with JWT token(service account token) injected.
</span></span><span style="display:flex;"><span> <span style="color:#ff79c6">-</span> API calls to Vault to authenticate from pod, Vault verifies the token and determine policies attached to the Auth token,
</span></span><span style="display:flex;"><span>and return to client.
</span></span><span style="display:flex;"><span> <span style="color:#ff79c6">-</span> API calls to Vault with Auth token passed to retrieves required secrets.
</span></span></code></pre></div><h1 id="vault-agent-solution">Vault Agent solution</h1>
<p>Vault agent provides helper features to address the following challenges:</p>
<ul>
<li>Automatic authentication</li>
<li>Secure delivery/storage of tokens</li>
<li>Lifecycle management of these tokens (renewal &amp; re-authentication)<br>
<img src='/img/2023-03-26-vault-agent-with-k8s/vault-agent-01.png' style="height: 220px;margin-left: 0px;"/></li>
</ul>
<h1 id="configure-kubernetes-authentication">Configure kubernetes authentication</h1>
<p>Vault provides a Kubernetes authentication method that enables clients to authenticate with a Kubernetes Service Account
Token. This token is provided to each pod when it is created.</p>
<h2 id="create-vault-service-account">Create Vault service account</h2>
<ol>
<li>Create k8s manifest file</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">export</span> <span style="color:#8be9fd;font-style:italic">WORKDIR</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">$(</span><span style="color:#8be9fd;font-style:italic">pwd</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cat &gt; <span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">WORKDIR</span><span style="color:#f1fa8c">}</span>/vault-auth-service-account.yaml <span style="color:#f1fa8c">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">apiVersion: v1
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">kind: ServiceAccount
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">  name: vault-auth
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">---
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">kind: ClusterRoleBinding
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">  name: role-tokenreview-binding
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">roleRef:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">  apiGroup: rbac.authorization.k8s.io
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">  kind: ClusterRole
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">  name: system:auth-delegator
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">subjects:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">  - kind: ServiceAccount
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    name: vault-auth
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">EOF</span>
</span></span></code></pre></div><ol start="2">
<li>Create the vault-auth service account.
Important:  specify a namespace here!!!</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl apply --filename vault-auth-service-account.yaml -n default
</span></span></code></pre></div><ol start="3">
<li>(Kubernetes 1.24+ only) Create the secret explicitly</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat &gt; <span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">WORKDIR</span><span style="color:#f1fa8c">}</span>/vault-auth-secret.yaml <span style="color:#f1fa8c">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">apiVersion: v1
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">kind: Secret
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">  name: vault-auth-secret
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">  annotations:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    kubernetes.io/service-account.name: vault-auth
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">type: kubernetes.io/service-account-token
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl apply --filename vault-auth-secret.yaml
</span></span></code></pre></div><h2 id="configure-kubernetes-auth-method">Configure Kubernetes auth method</h2>
<ol>
<li>Configure vault url &amp; login with root token.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#6272a4"># service url is also fine, here i changed master&#39;s host, and set ingress controller&#39;s IP to vault.it-meta.space also.</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">export</span> <span style="color:#8be9fd;font-style:italic">VAULT_ADDR</span><span style="color:#ff79c6">=</span>https://vault.it-meta.space
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">export</span> <span style="color:#8be9fd;font-style:italic">CLUSTER_ROOT_TOKEN</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">$(</span>cat <span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">WORKDIR</span><span style="color:#f1fa8c">}</span>/cluster-keys.json | jq -r <span style="color:#f1fa8c">&#34;.root_token&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>vault login <span style="color:#8be9fd;font-style:italic">token</span><span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">$CLUSTER_ROOT_TOKEN</span>
</span></span></code></pre></div><p>Sample output:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@master:/opt/k8s/config-repo/vault# <span style="color:#8be9fd;font-style:italic">export</span> <span style="color:#8be9fd;font-style:italic">VAULT_ADDR</span><span style="color:#ff79c6">=</span>https://vault.it-meta.space
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">export</span> <span style="color:#8be9fd;font-style:italic">CLUSTER_ROOT_TOKEN</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">$(</span>cat <span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">WORKDIR</span><span style="color:#f1fa8c">}</span>/cluster-keys.json | jq -r <span style="color:#f1fa8c">&#34;.root_token&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>vault login <span style="color:#8be9fd;font-style:italic">token</span><span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">$CLUSTER_ROOT_TOKEN</span>
</span></span><span style="display:flex;"><span>Success! You are now authenticated. The token information displayed below
</span></span><span style="display:flex;"><span>is already stored in the token helper. You <span style="color:#ff79c6">do</span> NOT need to run <span style="color:#f1fa8c">&#34;vault login&#34;</span>
</span></span><span style="display:flex;"><span>again. Future Vault requests will automatically use this token.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Key                  Value
</span></span><span style="display:flex;"><span>---                  -----
</span></span><span style="display:flex;"><span>token                hvs.oemGqKix23q5FMi6qkXiLsqN
</span></span><span style="display:flex;"><span>token_accessor       BVDmPTEBLgdxLEvQs4p5bXaD
</span></span><span style="display:flex;"><span>token_duration       ∞
</span></span><span style="display:flex;"><span>token_renewable      <span style="color:#8be9fd;font-style:italic">false</span>
</span></span><span style="display:flex;"><span>token_policies       <span style="color:#ff79c6">[</span><span style="color:#f1fa8c">&#34;root&#34;</span><span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>identity_policies    <span style="color:#ff79c6">[]</span>
</span></span><span style="display:flex;"><span>policies             <span style="color:#ff79c6">[</span><span style="color:#f1fa8c">&#34;root&#34;</span><span style="color:#ff79c6">]</span>
</span></span></code></pre></div><ol start="2">
<li>Set a secret in Vault</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>vault secrets <span style="color:#8be9fd;font-style:italic">enable</span> -path<span style="color:#ff79c6">=</span>secret kv
</span></span><span style="display:flex;"><span>vault kv put secret/data/app/config <span style="color:#8be9fd;font-style:italic">username</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;jamie&#34;</span> <span style="color:#8be9fd;font-style:italic">password</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;HLWD20230326&#34;</span>
</span></span><span style="display:flex;"><span>vault kv get secret/data/app/config
</span></span></code></pre></div><ol start="3">
<li>Configure Kubernetes authentication method</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">export</span> <span style="color:#8be9fd;font-style:italic">SA_SECRET_NAME</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">$(</span>kubectl get secrets --output<span style="color:#ff79c6">=</span>json <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    | jq -r <span style="color:#f1fa8c">&#39;.items[].metadata | select(.name|startswith(&#34;vault-auth-&#34;)).name&#39;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">export</span> <span style="color:#8be9fd;font-style:italic">SA_JWT_TOKEN</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">$(</span>kubectl get secret <span style="color:#8be9fd;font-style:italic">$SA_SECRET_NAME</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    --output <span style="color:#f1fa8c">&#39;go-template={{ .data.token }}&#39;</span> | base64 --decode<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">export</span> <span style="color:#8be9fd;font-style:italic">SA_CA_CRT</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">$(</span>kubectl config view --raw --minify --flatten <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    --output <span style="color:#f1fa8c">&#39;jsonpath={.clusters[].cluster.certificate-authority-data}&#39;</span> | base64 --decode<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">export</span> <span style="color:#8be9fd;font-style:italic">K8S_HOST</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">$(</span>kubectl config view --raw --minify --flatten <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    --output <span style="color:#f1fa8c">&#39;jsonpath={.clusters[].cluster.server}&#39;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>vault auth <span style="color:#8be9fd;font-style:italic">enable</span> kubernetes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>vault write auth/kubernetes/config <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>     <span style="color:#8be9fd;font-style:italic">token_reviewer_jwt</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;</span><span style="color:#8be9fd;font-style:italic">$SA_JWT_TOKEN</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>     <span style="color:#8be9fd;font-style:italic">kubernetes_host</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;</span><span style="color:#8be9fd;font-style:italic">$K8S_HOST</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>     <span style="color:#8be9fd;font-style:italic">kubernetes_ca_cert</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;</span><span style="color:#8be9fd;font-style:italic">$SA_CA_CRT</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>     <span style="color:#8be9fd;font-style:italic">issuer</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;https://kubernetes.default.svc.cluster.local&#34;</span>
</span></span></code></pre></div><ol start="4">
<li>Create admin &amp; devops roles</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>vault write auth/kubernetes/role/app-admin <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>     <span style="color:#8be9fd;font-style:italic">bound_service_account_names</span><span style="color:#ff79c6">=</span>vault-auth <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>     <span style="color:#8be9fd;font-style:italic">bound_service_account_namespaces</span><span style="color:#ff79c6">=</span>default <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>     <span style="color:#8be9fd;font-style:italic">token_policies</span><span style="color:#ff79c6">=</span>policy-app-kv-rw <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>     <span style="color:#8be9fd;font-style:italic">ttl</span><span style="color:#ff79c6">=</span>1h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>vault write auth/kubernetes/role/app-devops <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>     <span style="color:#8be9fd;font-style:italic">bound_service_account_names</span><span style="color:#ff79c6">=</span>vault-auth <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>     <span style="color:#8be9fd;font-style:italic">bound_service_account_namespaces</span><span style="color:#ff79c6">=</span>default <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>     <span style="color:#8be9fd;font-style:italic">token_policies</span><span style="color:#ff79c6">=</span>policy-app-kv-ro <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>     <span style="color:#8be9fd;font-style:italic">ttl</span><span style="color:#ff79c6">=</span>4h   
</span></span></code></pre></div><ol start="5">
<li>Create RW &amp; RO policies</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>vault policy write policy-app-kv-rw - <span style="color:#f1fa8c">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">path &#34;secret/data/app/*&#34; {
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    capabilities = [&#34;read&#34;, &#34;list&#34;, &#34;delete&#34;, &#34;create&#34;, &#34;update&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">}
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>vault policy write policy-app-kv-ro - <span style="color:#f1fa8c">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">path &#34;secret/data/app/*&#34; {
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    capabilities = [&#34;read&#34;, &#34;list&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">}
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">EOF</span>
</span></span></code></pre></div><h1 id="lunch-application-for-testing">Lunch application for testing</h1>
<ol>
<li>Create deployment/pod</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat &gt; <span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">WORKDIR</span><span style="color:#f1fa8c">}</span>/test-deployment-with-vault-agent.yaml <span style="color:#f1fa8c">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">apiVersion: apps/v1
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">kind: Deployment
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">  name: nginx
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">  labels:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    app: test-vault-agent
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">  selector:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    matchLabels:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      app: test-vault-agent
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">  replicas: 1
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">  template:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      annotations:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        vault.hashicorp.com/agent-inject: &#39;true&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        vault.hashicorp.com/role: &#39;app-devops&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        vault.hashicorp.com/tls-skip-verify: &#34;true&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        vault.hashicorp.com/agent-pre-populate-only: &#39;true&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        vault.hashicorp.com/agent-inject-secret-app-config.yaml: &#39;secret/data/app/config&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      labels:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        app: test-vault-agent
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    spec:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      serviceAccountName: vault-auth
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      containers:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        - name: nginx
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">          image: nginx:latest
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">          imagePullPolicy: IfNotPresent
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>k apply -f test-deployment-with-vault-agent.yaml
</span></span></code></pre></div><ol start="2">
<li>Login pod to check the secrets</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@master:/opt/k8s/config-repo/vault# kubectl <span style="color:#8be9fd;font-style:italic">exec</span> <span style="color:#ff79c6">$(</span>kubectl get pod -l <span style="color:#8be9fd;font-style:italic">app</span><span style="color:#ff79c6">=</span>test-vault-agent -o <span style="color:#8be9fd;font-style:italic">jsonpath</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;{.items[0].metadata.name}&#34;</span><span style="color:#ff79c6">)</span> --container nginx -- cat /vault/secrets/app-config.yaml
</span></span><span style="display:flex;"><span>password: HLWD20230326
</span></span><span style="display:flex;"><span>username: jamie
</span></span></code></pre></div><ol start="3">
<li>Update secrets in vault, it seems cannot sync to pod automatically,  a quick apply way is to scale the app to 0 and scale back to original replicas.</li>
</ol>
<h1 id="integrate-with-spring-cloud-vault">Integrate with Spring Cloud Vault.</h1>
<p>Continue!</p>
<p>Reference docs:<br>
<a href="https://developer.hashicorp.com/vault/tutorials/kubernetes/kubernetes-sidecar">https://developer.hashicorp.com/vault/tutorials/kubernetes/kubernetes-sidecar</a></p>


                
                
<div class="entry-shang text-center">
    
	    <p>「真诚赞赏，手留余香」</p>
	
	<button class="zs show-zs btn btn-bred">赞赏支持</button>
</div>
<div class="zs-modal-bg"></div>
<div class="zs-modal-box">
	<div class="zs-modal-head">
		<button type="button" class="close">×</button>
		<span class="author"><a href="http://akjamie.github.io/"><img src="/img/favicon.png" />Jamie&#39;s Blog</a></span>
        
	        <p class="tip"><i></i><span>真诚赞赏，手留余香</span></p>
		
 
	</div>
	<div class="zs-modal-body">
		<div class="zs-modal-btns">
			<button class="btn btn-blink" data-num="2">2元</button>
			<button class="btn btn-blink" data-num="5">5元</button>
			<button class="btn btn-blink" data-num="10">10元</button>
			<button class="btn btn-blink" data-num="50">50元</button>
			<button class="btn btn-blink" data-num="100">100元</button>
			<button class="btn btn-blink" data-num="1">任意金额</button>
		</div>
		<div class="zs-modal-pay">
			<button class="btn btn-bred" id="pay-text">2元</button>
			<p>使用<span id="pay-type">微信</span>扫描二维码完成支付</p>
			<img src="/img/reward/wechat-2.png"  id="pay-image"/>
		</div>
	</div>
	<div class="zs-modal-footer">
		<label><input type="radio" name="zs-type" value="wechat" class="zs-type" checked="checked"><span ><span class="zs-wechat"><img src="/img/reward/wechat-btn.png"/></span></label>
		<label><input type="radio" name="zs-type" value="alipay" class="zs-type" class="zs-alipay"><img src="/img/reward/alipay-btn.png"/></span></label>
	</div>
</div>
<script type="text/javascript" src="/js/reward.js"></script>

                

                
                <hr>
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/post/2023-03-25-vault-on-k8s/" data-toggle="tooltip" data-placement="top" title="Vault on Kubernetes">&larr;
                            Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/post/2023-04-08-k8s-pv-pvc-access-mode/" data-toggle="tooltip" data-placement="top" title="Explore Kubernetes Local PV &amp; PVC access mode">Next
                            Post &rarr;</a>
                    </li>
                    
                </ul>
                

                




            </div>

            
            
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
            

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/aws" title="aws">
                            aws
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/docker" title="docker">
                            docker
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/k8s" title="k8s">
                            k8s
                        </a>
                        
                        
                        
                        <a href="/tags/kubernetes" title="kubernetes">
                            kubernetes
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/llm" title="llm">
                            llm
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/nosql" title="nosql">
                            nosql
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/python" title="python">
                            python
                        </a>
                        
                        
                        
                        <a href="/tags/redis" title="redis">
                            redis
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/spring" title="spring">
                            spring
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/spring-cloud" title="spring cloud">
                            spring cloud
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/transaction-management" title="transaction management">
                            transaction management
                        </a>
                        
                        
                        
                        <a href="/tags/transformer" title="transformer">
                            transformer
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/vault" title="vault">
                            vault
                        </a>
                        
                        
                        
                        
                    </div>
                </section>
                

                
                
                <section>
                    <hr>
                    <h5>FRIENDS</h5>
                    <ul class="list-inline">
                        
                    </ul>
                </section>
                
            </div>
        </div>
    </div>
</article>




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    
                    <li>
                        <a href="mailto:akjamie.zhang@outlook.com">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		           
                    
                    
                    
                    

		            
                    
                    <li>
                        <a target="_blank" href="/img/wechat-qrcode.png">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-weixin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		            
                    
                    <li>
                        <a target="_blank" href="https://github.com/akjamie">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		            
                    
                    
                    
                    <li>
                        <a target="_blank" href="https://www.linkedin.com/in/jamie-zhang">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		           
                    
                    
                    
                    
                    
                    
            
            
            
           
                   <li>
                       <a href='' rel="alternate" type="application/rss+xml" title="Jamie&#39;s Blog" >
                           <span class="fa-stack fa-lg">
                               <i class="fas fa-circle fa-stack-2x"></i>
                               <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
                           </span>
                       </a>
                   </li>
            
             </ul>
		<p class="copyright text-muted">
                    Copyright &copy; Jamie&#39;s Blog 2025
                    
                </p>
            </div>
        </div>
    </div>
</footer>




<script>
    function loadAsync(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>






<script>
    
    if($('#tag_cloud').length !== 0){
        loadAsync("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script>
    loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>






<script type="text/javascript">
    function generateCatalog(selector) {

        
        
        
        
            _containerSelector = 'div.post-container'
        

        
        var P = $(_containerSelector), a, n, t, l, i, c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        
        $(selector).html('')

        
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#" + $(this).prop('id');
            t = $(this).text();
            c = $('<a href="' + i + '" rel="nofollow" title="' + t + '">' + t + '</a>');
            l = $('<li class="' + n + '_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    
    $(".catalog-toggle").click((function (e) {
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    


    loadAsync("\/js\/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>







</body>
</html>
