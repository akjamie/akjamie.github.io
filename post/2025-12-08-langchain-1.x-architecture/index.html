<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <meta property="og:site_name" content="Jamie&#39;s Blog">
    <meta property="og:type" content="article">

    
    <meta property="og:image" content="http://akjamie.github.io/img/ai-01.jpg">
    <meta property="twitter:image" content="http://akjamie.github.io/img/ai-01.jpg" />
    

    
    <meta name="title" content="LangChain 1.x Architecture Guide for Tech Leads and Solution Architects" />
    <meta property="og:title" content="LangChain 1.x Architecture Guide for Tech Leads and Solution Architects" />
    <meta property="twitter:title" content="LangChain 1.x Architecture Guide for Tech Leads and Solution Architects" />
    

    
    <meta name="description" content="A Production-Ready Blueprint for Building Enterprise AI Agent Solutions.">
    <meta property="og:description" content="A Production-Ready Blueprint for Building Enterprise AI Agent Solutions." />
    <meta property="twitter:description" content="A Production-Ready Blueprint for Building Enterprise AI Agent Solutions." />
    

    <meta property="og:url" content="http://akjamie.github.io/post/2025-12-08-langchain-1.x-architecture/" />

    
    <meta property="twitter:card" content="summary" />
    
    

    <meta name="keyword"  content="
&#34;Jamie Zhang, 博客, 个人网站, 互联网, Web, 云原生, Kubernetes, 微服务, Microservice&#34;">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>LangChain 1.x Architecture Guide for Tech Leads and Solution Architects | Jamie&#39;s Blog</title>

    <link rel="canonical" href="/post/2025-12-08-langchain-1.x-architecture/">

    

    
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    
    <link rel="stylesheet" href="/css/hugo-theme-cleanwhite.min.css">

    
    <link rel="stylesheet" href="/css/zanshang.min.css">

    
    <link rel="stylesheet" href="/css/font-awesome.all.min.css">

    
    
    
    

    
    <script src="/js/jquery.min.js"></script>

    
    <script src="/js/bootstrap.min.js"></script>

    
    <script src="/js/hux-blog.min.js"></script>

    
    <script src="/js/lazysizes.min.js"></script>

    
    

</head>





<nav class="navbar navbar-default navbar-custom navbar-fixed-top">

    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Jamie&#39;s Blog</a>
        </div>

        
        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">All Posts</a>
                    </li>
                    
                        
                        <li>
                            <a href="/categories/ai/">ai</a>
                        </li>
                        
                        <li>
                            <a href="/categories/cloud/">cloud</a>
                        </li>
                        
                        <li>
                            <a href="/categories/deep-learning/">deep learning</a>
                        </li>
                        
                        <li>
                            <a href="/categories/langchain/">langchain</a>
                        </li>
                        
                        <li>
                            <a href="/categories/microservice/">microservice</a>
                        </li>
                        
                        <li>
                            <a href="/categories/nosql/">nosql</a>
                        </li>
                        
                        <li>
                            <a href="/categories/others/">others</a>
                        </li>
                        
                    
                    
		    
		            <li>
                        <a href="/search"><i class="fa fa-search"></i></a>
		           </li>
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    
    
    
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        
            $navbar.className = " ";
            
            setTimeout(function(){
                
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>



<header class="intro-header" style="background-image: url('/img/header-01.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 ">
                <div class="site-heading">
                    <h1>Jamie&#39;s Blog </h1>
                    
		    <span class="subheading">Building the future, one line of code at a time.</span>
                </div>
            </div>
        </div>
    </div>
</header>




<article>
    <div class="container">
        <div class="row">
            
            <div class="
            col-lg-8 col-lg-offset-1
            col-md-8 col-md-offset-1
            col-sm-12
            col-xs-12
            post-container">
            
                <h1 id="the-complete-langchain-1x-architecture-guide-for-tech-leads-and-solution-architects">The Complete LangChain 1.x Architecture Guide for Tech Leads and Solution Architects</h1>
<p><strong>A Production-Ready Blueprint for Building Enterprise AI Agent Solutions</strong></p>
<p><em>Last Updated: December 2025 | Reading Time: 25 minutes</em></p>
<hr>
<h2 id="introduction">Introduction</h2>
<p>If you&rsquo;re a tech lead or solution architect evaluating LangChain for your next AI agent project, this guide is for you. LangChain 1.x represents a significant maturation of the framework, shifting from experimental prototypes to production-ready agent systems. This isn&rsquo;t just another tutorial—it&rsquo;s a comprehensive architectural deep-dive designed to help you make informed decisions about building scalable AI solutions.</p>
<h3 id="what-youll-learn">What You&rsquo;ll Learn</h3>
<ul>
<li><strong>System Architecture</strong>: How LangChain 1.x components fit together</li>
<li><strong>Design Patterns</strong>: Production-proven patterns for agent systems</li>
<li><strong>Implementation Strategies</strong>: Real code examples for common use cases</li>
<li><strong>Operational Excellence</strong>: Observability, deployment, and scaling considerations</li>
<li><strong>Migration Insights</strong>: How 1.x differs from previous versions</li>
</ul>
<h3 id="who-this-guide-is-for">Who This Guide Is For</h3>
<ul>
<li><strong>Tech Leads</strong> evaluating LangChain for production deployments</li>
<li><strong>Solution Architects</strong> designing AI-powered systems</li>
<li><strong>Engineering Managers</strong> planning AI agent initiatives</li>
<li><strong>Senior Engineers</strong> implementing agent-based solutions</li>
</ul>
<hr>
<h2 id="part-1-understanding-the-langchain-1x-architecture">Part 1: Understanding the LangChain 1.x Architecture</h2>
<h3 id="the-architectural-shift-in-1x">The Architectural Shift in 1.x</h3>
<p>LangChain 1.x represents a fundamental rearchitecting around production requirements. The framework now prioritizes:</p>
<ol>
<li><strong>Durable Execution</strong>: Built on LangGraph&rsquo;s checkpoint system</li>
<li><strong>Simplified API Surface</strong>: <code>create_agent()</code> as the primary interface</li>
<li><strong>Middleware Architecture</strong>: Pluggable pre/post-processing</li>
<li><strong>Provider Agnosticism</strong>: 1000+ integrations maintained</li>
<li><strong>Production Readiness</strong>: Native observability and streaming</li>
</ol>
<p>This shift mirrors the maturation we&rsquo;ve seen in other infrastructure frameworks—moving from flexibility-first to reliability-first design.</p>
<h3 id="the-four-layer-architecture">The Four-Layer Architecture</h3>
<pre tabindex="0"><code>┌─────────────────────────────────────────────────────────┐
│                  Application Layer                       │
│         Your Business Logic &amp; Custom Solutions           │
└────────────────────┬────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────┐
│              LangChain 1.x Framework                     │
│  create_agent() • Middleware • Agent Patterns            │
└────────────────────┬────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────┐
│          LangGraph Runtime (Orchestration)               │
│  State Management • Checkpointing • Execution Control    │
└────────────────────┬────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────┐
│         LangChain-Core (Base Abstractions)               │
│  Models • Messages • Runnables • Tools • Parsers         │
└────────────────────┬────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────┐
│              External Integrations                       │
│  LLMs • Vector DBs • APIs • Tools • Data Sources         │
└─────────────────────────────────────────────────────────┘
</code></pre><img src='/img/2025-12-08-langchain-1x-architecture/system-arch-01.png' style="height: 816px;margin-left: 0px;"/>
<p><strong>Why This Matters for Architects:</strong></p>
<p>Each layer has clear responsibilities and interfaces. This separation enables:</p>
<ul>
<li><strong>Independent scaling</strong> of concerns</li>
<li><strong>Easy substitution</strong> of components (swap OpenAI for Anthropic without code changes)</li>
<li><strong>Clear testing boundaries</strong> (mock at layer interfaces)</li>
<li><strong>Gradual adoption</strong> (start with core, add complexity as needed)</li>
</ul>
<hr>
<h2 id="part-2-core-components-deep-dive">Part 2: Core Components Deep Dive</h2>
<h3 id="1-langchain-core-the-foundation">1. LangChain-Core: The Foundation</h3>
<p>LangChain-Core provides the fundamental abstractions. Understanding these is critical for architectural decisions.</p>
<h4 id="language-models-provider-agnostic-interface">Language Models: Provider-Agnostic Interface</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">from</span> langchain_openai <span style="color:#ff79c6">import</span> ChatOpenAI
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> langchain_anthropic <span style="color:#ff79c6">import</span> ChatAnthropic
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> langchain_google_genai <span style="color:#ff79c6">import</span> ChatGoogleGenerativeAI
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># All models share the same interface</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">class</span> <span style="color:#50fa7b">BaseChatModel</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">invoke</span>(messages: List[BaseMessage]) <span style="color:#ff79c6">-&gt;</span> BaseMessage
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">stream</span>(messages: List[BaseMessage]) <span style="color:#ff79c6">-&gt;</span> Iterator[BaseMessage]
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">batch</span>(messages: List[List[BaseMessage]]) <span style="color:#ff79c6">-&gt;</span> List[BaseMessage]
</span></span></code></pre></div><p><strong>Architectural Benefit</strong>: Your application code never depends on a specific provider. This is crucial for:</p>
<ul>
<li><strong>Cost optimization</strong>: Switch providers based on pricing</li>
<li><strong>Reliability</strong>: Fallback to alternative providers</li>
<li><strong>Feature access</strong>: Use different models for different tasks</li>
<li><strong>Vendor negotiation</strong>: Maintain optionality</li>
</ul>
<h4 id="lcel-the-composition-engine">LCEL: The Composition Engine</h4>
<p>LangChain Expression Language (LCEL) is the composability layer:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">from</span> langchain_core.runnables <span style="color:#ff79c6">import</span> RunnableSequence
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Declarative pipeline construction</span>
</span></span><span style="display:flex;"><span>chain <span style="color:#ff79c6">=</span> (
</span></span><span style="display:flex;"><span>    prompt_template 
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">|</span> model 
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">|</span> output_parser
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Automatic parallelization</span>
</span></span><span style="display:flex;"><span>parallel <span style="color:#ff79c6">=</span> RunnableParallel({
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;summary&#34;</span>: summarize_chain,
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;sentiment&#34;</span>: sentiment_chain,
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;entities&#34;</span>: entity_chain
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><p><strong>Why This Matters</strong>: LCEL provides automatic streaming, batching, and retry logic. For architects, this means:</p>
<ul>
<li>Reduced boilerplate code</li>
<li>Built-in performance optimizations</li>
<li>Easier testing and debugging</li>
<li>Type-safe composition</li>
</ul>
<h3 id="2-langgraph-the-orchestration-runtime">2. LangGraph: The Orchestration Runtime</h3>
<p>LangGraph is the execution engine. It&rsquo;s what makes LangChain 1.x production-ready.</p>
<h4 id="state-management-durable-by-design">State Management: Durable by Design</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">from</span> typing <span style="color:#ff79c6">import</span> TypedDict, Annotated
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> langgraph.graph <span style="color:#ff79c6">import</span> add_messages
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">class</span> <span style="color:#50fa7b">AgentState</span>(TypedDict):
</span></span><span style="display:flex;"><span>    messages: Annotated[<span style="color:#8be9fd;font-style:italic">list</span>, add_messages]
</span></span><span style="display:flex;"><span>    intermediate_steps: <span style="color:#8be9fd;font-style:italic">list</span>
</span></span><span style="display:flex;"><span>    metadata: <span style="color:#8be9fd;font-style:italic">dict</span>
</span></span></code></pre></div><p><strong>Key Architectural Features:</strong></p>
<ol>
<li><strong>Checkpointing</strong>: Every state transition is saved</li>
<li><strong>Resumability</strong>: Restart from any checkpoint after failures</li>
<li><strong>Time Travel</strong>: Debug by replaying execution</li>
<li><strong>Branching</strong>: Fork conversations from any point</li>
</ol>
<p><strong>Production Implications:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">from</span> langgraph.checkpoint.postgres <span style="color:#ff79c6">import</span> PostgresSaver
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Production configuration</span>
</span></span><span style="display:flex;"><span>checkpointer <span style="color:#ff79c6">=</span> PostgresSaver<span style="color:#ff79c6">.</span>from_conn_string(
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;postgresql://user:pass@db/langchain&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>agent <span style="color:#ff79c6">=</span> create_agent(
</span></span><span style="display:flex;"><span>    model<span style="color:#ff79c6">=</span>model,
</span></span><span style="display:flex;"><span>    tools<span style="color:#ff79c6">=</span>tools,
</span></span><span style="display:flex;"><span>    checkpointer<span style="color:#ff79c6">=</span>checkpointer  <span style="color:#6272a4"># Durable execution enabled</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p>This architecture supports:</p>
<ul>
<li><strong>Fault tolerance</strong>: Resume after crashes</li>
<li><strong>Debugging</strong>: Replay failed executions</li>
<li><strong>Compliance</strong>: Full audit trail</li>
<li><strong>Testing</strong>: Deterministic replay of scenarios</li>
</ul>
<h3 id="3-create_agent-the-primary-interface">3. create_agent(): The Primary Interface</h3>
<p>LangChain 1.x simplifies agent creation with a single function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">from</span> langchain <span style="color:#ff79c6">import</span> create_agent
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> langchain_openai <span style="color:#ff79c6">import</span> ChatOpenAI
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> langgraph.checkpoint.postgres <span style="color:#ff79c6">import</span> PostgresSaver
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>agent <span style="color:#ff79c6">=</span> create_agent(
</span></span><span style="display:flex;"><span>    model<span style="color:#ff79c6">=</span>ChatOpenAI(model<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;gpt-4&#34;</span>),
</span></span><span style="display:flex;"><span>    tools<span style="color:#ff79c6">=</span>[search_tool, calculator_tool, database_tool],
</span></span><span style="display:flex;"><span>    prompt<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;You are a data analyst assistant.&#34;</span>,
</span></span><span style="display:flex;"><span>    middleware<span style="color:#ff79c6">=</span>[pii_middleware, logging_middleware],
</span></span><span style="display:flex;"><span>    checkpointer<span style="color:#ff79c6">=</span>PostgresSaver<span style="color:#ff79c6">.</span>from_conn_string(DATABASE_URL),
</span></span><span style="display:flex;"><span>    interrupt_before<span style="color:#ff79c6">=</span>[<span style="color:#f1fa8c">&#34;tools&#34;</span>],  <span style="color:#6272a4"># Human-in-the-loop</span>
</span></span><span style="display:flex;"><span>    max_iterations<span style="color:#ff79c6">=</span><span style="color:#bd93f9">25</span>,
</span></span><span style="display:flex;"><span>    max_execution_time<span style="color:#ff79c6">=</span><span style="color:#bd93f9">120.0</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p><strong>Architectural Decisions Encoded:</strong></p>
<ul>
<li><strong>Model selection</strong>: Choose based on cost/performance tradeoffs</li>
<li><strong>Tool composition</strong>: What capabilities the agent has</li>
<li><strong>Middleware pipeline</strong>: Cross-cutting concerns (security, logging)</li>
<li><strong>State persistence</strong>: Where and how to store state</li>
<li><strong>Control flow</strong>: When to interrupt for approval</li>
<li><strong>Safety limits</strong>: Prevent runaway execution</li>
</ul>
<hr>
<h2 id="part-3-production-architecture-patterns">Part 3: Production Architecture Patterns</h2>
<img src='/img/2025-12-08-langchain-1x-architecture/system-arch-02.png' style="height: 1244px;margin-left: 0px;"/>
<h3 id="pattern-1-rag-retrieval-augmented-generation">Pattern 1: RAG (Retrieval-Augmented Generation)</h3>
<p>RAG is the most common enterprise pattern. Here&rsquo;s a production-ready implementation:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">from</span> langchain_openai <span style="color:#ff79c6">import</span> ChatOpenAI, OpenAIEmbeddings
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> langchain_pinecone <span style="color:#ff79c6">import</span> PineconeVectorStore
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> langchain_text_splitters <span style="color:#ff79c6">import</span> RecursiveCharacterTextSplitter
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> langchain_core.tools <span style="color:#ff79c6">import</span> tool
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">class</span> <span style="color:#50fa7b">RAGSystem</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">__init__</span>(<span style="font-style:italic">self</span>, index_name: <span style="color:#8be9fd;font-style:italic">str</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># Vector store for retrieval</span>
</span></span><span style="display:flex;"><span>        <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>vectorstore <span style="color:#ff79c6">=</span> PineconeVectorStore<span style="color:#ff79c6">.</span>from_existing_index(
</span></span><span style="display:flex;"><span>            index_name<span style="color:#ff79c6">=</span>index_name,
</span></span><span style="display:flex;"><span>            embedding<span style="color:#ff79c6">=</span>OpenAIEmbeddings()
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># Create retrieval tool</span>
</span></span><span style="display:flex;"><span>        @tool
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">search_knowledge_base</span>(query: <span style="color:#8be9fd;font-style:italic">str</span>) <span style="color:#ff79c6">-&gt;</span> <span style="color:#8be9fd;font-style:italic">str</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;&#34;&#34;Search the company knowledge base.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            docs <span style="color:#ff79c6">=</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>vectorstore<span style="color:#ff79c6">.</span>similarity_search(query, k<span style="color:#ff79c6">=</span><span style="color:#bd93f9">5</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\n\n</span><span style="color:#f1fa8c">&#34;</span><span style="color:#ff79c6">.</span>join([
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;Document </span><span style="color:#f1fa8c">{</span>i<span style="color:#ff79c6">+</span><span style="color:#bd93f9">1</span><span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">:</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">{</span>doc<span style="color:#ff79c6">.</span>page_content<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span> 
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">for</span> i, doc <span style="color:#ff79c6">in</span> <span style="color:#8be9fd;font-style:italic">enumerate</span>(docs)
</span></span><span style="display:flex;"><span>            ])
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># Create agent with retrieval capability</span>
</span></span><span style="display:flex;"><span>        <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>agent <span style="color:#ff79c6">=</span> create_agent(
</span></span><span style="display:flex;"><span>            model<span style="color:#ff79c6">=</span>ChatOpenAI(model<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;gpt-4&#34;</span>, temperature<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0</span>),
</span></span><span style="display:flex;"><span>            tools<span style="color:#ff79c6">=</span>[search_knowledge_base],
</span></span><span style="display:flex;"><span>            prompt<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;&#34;&#34;You are a knowledgeable assistant with access to 
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">            the company knowledge base. Always search the knowledge base 
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">            before answering questions. Cite sources when possible.&#34;&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>            checkpointer<span style="color:#ff79c6">=</span>PostgresSaver<span style="color:#ff79c6">.</span>from_conn_string(os<span style="color:#ff79c6">.</span>getenv(<span style="color:#f1fa8c">&#34;DB_URL&#34;</span>))
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">query</span>(<span style="font-style:italic">self</span>, question: <span style="color:#8be9fd;font-style:italic">str</span>, thread_id: <span style="color:#8be9fd;font-style:italic">str</span>) <span style="color:#ff79c6">-&gt;</span> <span style="color:#8be9fd;font-style:italic">str</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;&#34;&#34;Execute RAG query&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        config <span style="color:#ff79c6">=</span> {<span style="color:#f1fa8c">&#34;configurable&#34;</span>: {<span style="color:#f1fa8c">&#34;thread_id&#34;</span>: thread_id}}
</span></span><span style="display:flex;"><span>        result <span style="color:#ff79c6">=</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>agent<span style="color:#ff79c6">.</span>invoke(
</span></span><span style="display:flex;"><span>            {<span style="color:#f1fa8c">&#34;messages&#34;</span>: [{<span style="color:#f1fa8c">&#34;role&#34;</span>: <span style="color:#f1fa8c">&#34;user&#34;</span>, <span style="color:#f1fa8c">&#34;content&#34;</span>: question}]},
</span></span><span style="display:flex;"><span>            config
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> result[<span style="color:#f1fa8c">&#34;messages&#34;</span>][<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>]<span style="color:#ff79c6">.</span>content
</span></span></code></pre></div><p><strong>Architecture Considerations:</strong></p>
<ul>
<li><strong>Vector store selection</strong>: Pinecone for managed, Chroma for self-hosted</li>
<li><strong>Embedding strategy</strong>: Consider cost vs. quality tradeoffs</li>
<li><strong>Chunk size</strong>: Balance between context and relevance</li>
<li><strong>Retrieval tuning</strong>: Adjust k parameter based on use case</li>
<li><strong>Caching</strong>: Consider caching frequent queries</li>
</ul>
<p><strong>Cost Optimization:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4"># Use cheaper embeddings for large corpora</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> langchain_community.embeddings <span style="color:#ff79c6">import</span> HuggingFaceEmbeddings
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>embeddings <span style="color:#ff79c6">=</span> HuggingFaceEmbeddings(
</span></span><span style="display:flex;"><span>    model_name<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;sentence-transformers/all-MiniLM-L6-v2&#34;</span>
</span></span><span style="display:flex;"><span>)  <span style="color:#6272a4"># Free, runs locally</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Use tiered model strategy</span>
</span></span><span style="display:flex;"><span>cheap_model <span style="color:#ff79c6">=</span> ChatOpenAI(model<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;gpt-3.5-turbo&#34;</span>)
</span></span><span style="display:flex;"><span>expensive_model <span style="color:#ff79c6">=</span> ChatOpenAI(model<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;gpt-4&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Route based on complexity</span>
</span></span><span style="display:flex;"><span>agent <span style="color:#ff79c6">=</span> create_agent(
</span></span><span style="display:flex;"><span>    model<span style="color:#ff79c6">=</span>cheap_model,  <span style="color:#6272a4"># Default to cheaper model</span>
</span></span><span style="display:flex;"><span>    tools<span style="color:#ff79c6">=</span>[search_knowledge_base],
</span></span><span style="display:flex;"><span>    middleware<span style="color:#ff79c6">=</span>[ModelRoutingMiddleware(expensive_model)]  <span style="color:#6272a4"># Upgrade when needed</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><h3 id="pattern-2-multi-agent-systems">Pattern 2: Multi-Agent Systems</h3>
<p>For complex workflows, decompose into specialized agents:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">class</span> <span style="color:#50fa7b">MultiAgentArchitecture</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">__init__</span>(<span style="font-style:italic">self</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># Specialized agents</span>
</span></span><span style="display:flex;"><span>        <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>researcher <span style="color:#ff79c6">=</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>_create_researcher()
</span></span><span style="display:flex;"><span>        <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>analyst <span style="color:#ff79c6">=</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>_create_analyst()
</span></span><span style="display:flex;"><span>        <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>writer <span style="color:#ff79c6">=</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>_create_writer()
</span></span><span style="display:flex;"><span>        <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>supervisor <span style="color:#ff79c6">=</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>_create_supervisor()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">_create_researcher</span>(<span style="font-style:italic">self</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;&#34;&#34;Agent for gathering information&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> create_agent(
</span></span><span style="display:flex;"><span>            model<span style="color:#ff79c6">=</span>ChatOpenAI(model<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;gpt-4&#34;</span>),
</span></span><span style="display:flex;"><span>            tools<span style="color:#ff79c6">=</span>[web_search, document_reader, api_caller],
</span></span><span style="display:flex;"><span>            prompt<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;You are a research specialist. Gather comprehensive data.&#34;</span>,
</span></span><span style="display:flex;"><span>            checkpointer<span style="color:#ff79c6">=</span>PostgresSaver<span style="color:#ff79c6">.</span>from_conn_string(
</span></span><span style="display:flex;"><span>                os<span style="color:#ff79c6">.</span>getenv(<span style="color:#f1fa8c">&#34;DB_URL&#34;</span>), 
</span></span><span style="display:flex;"><span>                namespace<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;researcher&#34;</span>
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">_create_analyst</span>(<span style="font-style:italic">self</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;&#34;&#34;Agent for data analysis&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> create_agent(
</span></span><span style="display:flex;"><span>            model<span style="color:#ff79c6">=</span>ChatOpenAI(model<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;gpt-4&#34;</span>),
</span></span><span style="display:flex;"><span>            tools<span style="color:#ff79c6">=</span>[python_repl, data_visualizer],
</span></span><span style="display:flex;"><span>            prompt<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;You are a data analyst. Analyze data and extract insights.&#34;</span>,
</span></span><span style="display:flex;"><span>            checkpointer<span style="color:#ff79c6">=</span>PostgresSaver<span style="color:#ff79c6">.</span>from_conn_string(
</span></span><span style="display:flex;"><span>                os<span style="color:#ff79c6">.</span>getenv(<span style="color:#f1fa8c">&#34;DB_URL&#34;</span>),
</span></span><span style="display:flex;"><span>                namespace<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;analyst&#34;</span>
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">_create_supervisor</span>(<span style="font-style:italic">self</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;&#34;&#34;Orchestrating agent&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        @tool
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">delegate_research</span>(task: <span style="color:#8be9fd;font-style:italic">str</span>) <span style="color:#ff79c6">-&gt;</span> <span style="color:#8be9fd;font-style:italic">str</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;&#34;&#34;Delegate to research agent&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>researcher<span style="color:#ff79c6">.</span>invoke(
</span></span><span style="display:flex;"><span>                {<span style="color:#f1fa8c">&#34;messages&#34;</span>: [{<span style="color:#f1fa8c">&#34;role&#34;</span>: <span style="color:#f1fa8c">&#34;user&#34;</span>, <span style="color:#f1fa8c">&#34;content&#34;</span>: task}]},
</span></span><span style="display:flex;"><span>                {<span style="color:#f1fa8c">&#34;configurable&#34;</span>: {<span style="color:#f1fa8c">&#34;thread_id&#34;</span>: <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;research_</span><span style="color:#f1fa8c">{</span><span style="color:#8be9fd;font-style:italic">hash</span>(task)<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>}}
</span></span><span style="display:flex;"><span>            )[<span style="color:#f1fa8c">&#34;messages&#34;</span>][<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>]<span style="color:#ff79c6">.</span>content
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        @tool
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">delegate_analysis</span>(task: <span style="color:#8be9fd;font-style:italic">str</span>, data: <span style="color:#8be9fd;font-style:italic">str</span>) <span style="color:#ff79c6">-&gt;</span> <span style="color:#8be9fd;font-style:italic">str</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;&#34;&#34;Delegate to analyst agent&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>analyst<span style="color:#ff79c6">.</span>invoke(
</span></span><span style="display:flex;"><span>                {<span style="color:#f1fa8c">&#34;messages&#34;</span>: [{<span style="color:#f1fa8c">&#34;role&#34;</span>: <span style="color:#f1fa8c">&#34;user&#34;</span>, <span style="color:#f1fa8c">&#34;content&#34;</span>: <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">{</span>task<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">\n\n</span><span style="color:#f1fa8c">Data:</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">{</span>data<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>}]},
</span></span><span style="display:flex;"><span>                {<span style="color:#f1fa8c">&#34;configurable&#34;</span>: {<span style="color:#f1fa8c">&#34;thread_id&#34;</span>: <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;analysis_</span><span style="color:#f1fa8c">{</span><span style="color:#8be9fd;font-style:italic">hash</span>(task)<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>}}
</span></span><span style="display:flex;"><span>            )[<span style="color:#f1fa8c">&#34;messages&#34;</span>][<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>]<span style="color:#ff79c6">.</span>content
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> create_agent(
</span></span><span style="display:flex;"><span>            model<span style="color:#ff79c6">=</span>ChatOpenAI(model<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;gpt-4&#34;</span>),
</span></span><span style="display:flex;"><span>            tools<span style="color:#ff79c6">=</span>[delegate_research, delegate_analysis],
</span></span><span style="display:flex;"><span>            prompt<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;&#34;&#34;You are a supervisor coordinating specialized agents.
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">            Break down complex tasks and delegate to appropriate agents.&#34;&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>            checkpointer<span style="color:#ff79c6">=</span>PostgresSaver<span style="color:#ff79c6">.</span>from_conn_string(os<span style="color:#ff79c6">.</span>getenv(<span style="color:#f1fa8c">&#34;DB_URL&#34;</span>))
</span></span><span style="display:flex;"><span>        )
</span></span></code></pre></div><p><strong>When to Use Multi-Agent:</strong></p>
<p>✅ Complex workflows with distinct phases
✅ Different expertise required (research vs. analysis vs. writing)
✅ Need for parallel execution
✅ Want to optimize model selection per task</p>
<p>❌ Simple, linear workflows
❌ Real-time, low-latency requirements
❌ Limited budget (more agents = more LLM calls)</p>
<h3 id="pattern-3-human-in-the-loop-for-compliance">Pattern 3: Human-in-the-Loop for Compliance</h3>
<p>Critical for regulated industries:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">from</span> langchain.middleware <span style="color:#ff79c6">import</span> HumanInTheLoopMiddleware
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">class</span> <span style="color:#50fa7b">ComplianceAgent</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">__init__</span>(<span style="font-style:italic">self</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># Define sensitive operations</span>
</span></span><span style="display:flex;"><span>        <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>sensitive_operations <span style="color:#ff79c6">=</span> [
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;delete&#34;</span>, <span style="color:#f1fa8c">&#34;update_financial&#34;</span>, <span style="color:#f1fa8c">&#34;send_email&#34;</span>, 
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;make_purchase&#34;</span>, <span style="color:#f1fa8c">&#34;change_permissions&#34;</span>
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># Create approval middleware</span>
</span></span><span style="display:flex;"><span>        hitl <span style="color:#ff79c6">=</span> HumanInTheLoopMiddleware(
</span></span><span style="display:flex;"><span>            approval_required<span style="color:#ff79c6">=</span><span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>sensitive_operations,
</span></span><span style="display:flex;"><span>            timeout<span style="color:#ff79c6">=</span><span style="color:#bd93f9">300</span>  <span style="color:#6272a4"># 5 minute approval window</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># Create agent with HITL</span>
</span></span><span style="display:flex;"><span>        <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>agent <span style="color:#ff79c6">=</span> create_agent(
</span></span><span style="display:flex;"><span>            model<span style="color:#ff79c6">=</span>ChatOpenAI(model<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;gpt-4&#34;</span>),
</span></span><span style="display:flex;"><span>            tools<span style="color:#ff79c6">=</span><span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>_get_tools(),
</span></span><span style="display:flex;"><span>            middleware<span style="color:#ff79c6">=</span>[hitl],
</span></span><span style="display:flex;"><span>            interrupt_before<span style="color:#ff79c6">=</span>[<span style="color:#f1fa8c">&#34;tools&#34;</span>],  <span style="color:#6272a4"># Pause before tool execution</span>
</span></span><span style="display:flex;"><span>            checkpointer<span style="color:#ff79c6">=</span>PostgresSaver<span style="color:#ff79c6">.</span>from_conn_string(os<span style="color:#ff79c6">.</span>getenv(<span style="color:#f1fa8c">&#34;DB_URL&#34;</span>))
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">execute_with_approval</span>(
</span></span><span style="display:flex;"><span>        <span style="font-style:italic">self</span>, 
</span></span><span style="display:flex;"><span>        request: <span style="color:#8be9fd;font-style:italic">str</span>, 
</span></span><span style="display:flex;"><span>        user_id: <span style="color:#8be9fd;font-style:italic">str</span>,
</span></span><span style="display:flex;"><span>        approver_callback: Callable
</span></span><span style="display:flex;"><span>    ):
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;&#34;&#34;Execute request with approval workflow&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        config <span style="color:#ff79c6">=</span> {<span style="color:#f1fa8c">&#34;configurable&#34;</span>: {<span style="color:#f1fa8c">&#34;thread_id&#34;</span>: <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;user_</span><span style="color:#f1fa8c">{</span>user_id<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>}}
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># Start execution</span>
</span></span><span style="display:flex;"><span>        events <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">list</span>(<span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>agent<span style="color:#ff79c6">.</span>stream(
</span></span><span style="display:flex;"><span>            {<span style="color:#f1fa8c">&#34;messages&#34;</span>: [{<span style="color:#f1fa8c">&#34;role&#34;</span>: <span style="color:#f1fa8c">&#34;user&#34;</span>, <span style="color:#f1fa8c">&#34;content&#34;</span>: request}]},
</span></span><span style="display:flex;"><span>            config
</span></span><span style="display:flex;"><span>        ))
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># Check if approval needed</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>_is_interrupted(events):
</span></span><span style="display:flex;"><span>            <span style="color:#6272a4"># Extract pending action</span>
</span></span><span style="display:flex;"><span>            pending_action <span style="color:#ff79c6">=</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>_extract_action(events)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#6272a4"># Request approval</span>
</span></span><span style="display:flex;"><span>            approved <span style="color:#ff79c6">=</span> approver_callback(pending_action)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">if</span> approved:
</span></span><span style="display:flex;"><span>                <span style="color:#6272a4"># Resume execution</span>
</span></span><span style="display:flex;"><span>                result <span style="color:#ff79c6">=</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>agent<span style="color:#ff79c6">.</span>invoke(<span style="color:#ff79c6">None</span>, config)
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">return</span> result[<span style="color:#f1fa8c">&#34;messages&#34;</span>][<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>]<span style="color:#ff79c6">.</span>content
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">else</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;Action cancelled by approver&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># No approval needed, return result</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> events[<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>][<span style="color:#f1fa8c">&#34;messages&#34;</span>][<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>]<span style="color:#ff79c6">.</span>content
</span></span></code></pre></div><p><strong>Compliance Benefits:</strong></p>
<ul>
<li><strong>Audit trail</strong>: Every action logged with approval status</li>
<li><strong>Risk mitigation</strong>: Prevent unauthorized operations</li>
<li><strong>Flexibility</strong>: Different approval chains per operation type</li>
<li><strong>User experience</strong>: Async approval via webhooks/queues</li>
</ul>
<hr>
<h2 id="part-4-middleware-architecture">Part 4: Middleware Architecture</h2>
<p>Middleware is where you implement cross-cutting concerns. Think of it as the interceptor pattern for LLM interactions.</p>
<h3 id="the-middleware-pipeline">The Middleware Pipeline</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">from</span> langchain.middleware <span style="color:#ff79c6">import</span> BaseMiddleware
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">class</span> <span style="color:#50fa7b">BaseMiddleware</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">pre_process</span>(
</span></span><span style="display:flex;"><span>        <span style="font-style:italic">self</span>,
</span></span><span style="display:flex;"><span>        messages: List[BaseMessage],
</span></span><span style="display:flex;"><span>        metadata: <span style="color:#8be9fd;font-style:italic">dict</span>
</span></span><span style="display:flex;"><span>    ) <span style="color:#ff79c6">-&gt;</span> List[BaseMessage]:
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;&#34;&#34;Transform input before LLM&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">pass</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">post_process</span>(
</span></span><span style="display:flex;"><span>        <span style="font-style:italic">self</span>,
</span></span><span style="display:flex;"><span>        response: BaseMessage,
</span></span><span style="display:flex;"><span>        metadata: <span style="color:#8be9fd;font-style:italic">dict</span>
</span></span><span style="display:flex;"><span>    ) <span style="color:#ff79c6">-&gt;</span> BaseMessage:
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;&#34;&#34;Transform output after LLM&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">pass</span>
</span></span></code></pre></div><h3 id="essential-production-middleware">Essential Production Middleware</h3>
<h4 id="1-pii-detection--redaction">1. PII Detection &amp; Redaction</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">from</span> langchain.middleware <span style="color:#ff79c6">import</span> PIIMiddleware
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">class</span> <span style="color:#50fa7b">ProductionPIIMiddleware</span>(BaseMiddleware):
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;&#34;&#34;Enterprise-grade PII protection&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">__init__</span>(<span style="font-style:italic">self</span>, mode: <span style="color:#8be9fd;font-style:italic">str</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;redact&#34;</span>):
</span></span><span style="display:flex;"><span>        <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>detector <span style="color:#ff79c6">=</span> PIIDetector(
</span></span><span style="display:flex;"><span>            entities<span style="color:#ff79c6">=</span>[
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#34;EMAIL&#34;</span>, <span style="color:#f1fa8c">&#34;PHONE&#34;</span>, <span style="color:#f1fa8c">&#34;SSN&#34;</span>, <span style="color:#f1fa8c">&#34;CREDIT_CARD&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#34;IP_ADDRESS&#34;</span>, <span style="color:#f1fa8c">&#34;PERSON&#34;</span>, <span style="color:#f1fa8c">&#34;LOCATION&#34;</span>, <span style="color:#f1fa8c">&#34;DATE_OF_BIRTH&#34;</span>
</span></span><span style="display:flex;"><span>            ],
</span></span><span style="display:flex;"><span>            custom_patterns<span style="color:#ff79c6">=</span>{
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#34;EMPLOYEE_ID&#34;</span>: <span style="color:#f1fa8c">r</span><span style="color:#f1fa8c">&#34;EMP-\d</span><span style="color:#f1fa8c">{6}</span><span style="color:#f1fa8c">&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#34;CUSTOMER_ID&#34;</span>: <span style="color:#f1fa8c">r</span><span style="color:#f1fa8c">&#34;CUST-[A-Z0-9]</span><span style="color:#f1fa8c">{8}</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>mode <span style="color:#ff79c6">=</span> mode  <span style="color:#6272a4"># &#34;redact&#34;, &#34;block&#34;, or &#34;encrypt&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">pre_process</span>(<span style="font-style:italic">self</span>, messages, metadata):
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;&#34;&#34;Scan input for PII&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">for</span> message <span style="color:#ff79c6">in</span> messages:
</span></span><span style="display:flex;"><span>            detections <span style="color:#ff79c6">=</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>detector<span style="color:#ff79c6">.</span>scan(message<span style="color:#ff79c6">.</span>content)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">if</span> detections <span style="color:#ff79c6">and</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>mode <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#34;block&#34;</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">raise</span> PIIViolationError(
</span></span><span style="display:flex;"><span>                    <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;PII detected in input: </span><span style="color:#f1fa8c">{</span>detections<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>                )
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">elif</span> detections <span style="color:#ff79c6">and</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>mode <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#34;redact&#34;</span>:
</span></span><span style="display:flex;"><span>                message<span style="color:#ff79c6">.</span>content <span style="color:#ff79c6">=</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>detector<span style="color:#ff79c6">.</span>redact(message<span style="color:#ff79c6">.</span>content)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#6272a4"># Log for compliance</span>
</span></span><span style="display:flex;"><span>            metadata[<span style="color:#f1fa8c">&#34;pii_scan_result&#34;</span>] <span style="color:#ff79c6">=</span> detections
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> messages
</span></span></code></pre></div><p><strong>Why This Matters:</strong></p>
<ul>
<li>GDPR compliance requires PII protection</li>
<li>HIPAA mandates PHI safeguards</li>
<li>Reduces liability from data leaks</li>
<li>Builds customer trust</li>
</ul>
<h4 id="2-cost-tracking--budgets">2. Cost Tracking &amp; Budgets</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">class</span> <span style="color:#50fa7b">CostTrackingMiddleware</span>(BaseMiddleware):
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;&#34;&#34;Track and enforce LLM costs&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">__init__</span>(<span style="font-style:italic">self</span>, budget_per_user: <span style="color:#8be9fd;font-style:italic">float</span> <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">10.0</span>):
</span></span><span style="display:flex;"><span>        <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>costs <span style="color:#ff79c6">=</span> {}  <span style="color:#6272a4"># user_id -&gt; cost</span>
</span></span><span style="display:flex;"><span>        <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>budget_per_user <span style="color:#ff79c6">=</span> budget_per_user
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">pre_process</span>(<span style="font-style:italic">self</span>, messages, metadata):
</span></span><span style="display:flex;"><span>        user_id <span style="color:#ff79c6">=</span> metadata<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#34;user_id&#34;</span>)
</span></span><span style="display:flex;"><span>        current_cost <span style="color:#ff79c6">=</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>costs<span style="color:#ff79c6">.</span>get(user_id, <span style="color:#bd93f9">0</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> current_cost <span style="color:#ff79c6">&gt;=</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>budget_per_user:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">raise</span> BudgetExceededError(
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;User </span><span style="color:#f1fa8c">{</span>user_id<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c"> exceeded budget: $</span><span style="color:#f1fa8c">{</span>current_cost<span style="color:#f1fa8c">:</span><span style="color:#f1fa8c">.2f</span><span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> messages
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">post_process</span>(<span style="font-style:italic">self</span>, response, metadata):
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># Calculate cost</span>
</span></span><span style="display:flex;"><span>        tokens <span style="color:#ff79c6">=</span> metadata<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#34;token_usage&#34;</span>, {})
</span></span><span style="display:flex;"><span>        cost <span style="color:#ff79c6">=</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>_calculate_cost(tokens)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># Update tracking</span>
</span></span><span style="display:flex;"><span>        user_id <span style="color:#ff79c6">=</span> metadata<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#34;user_id&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>costs[user_id] <span style="color:#ff79c6">=</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>costs<span style="color:#ff79c6">.</span>get(user_id, <span style="color:#bd93f9">0</span>) <span style="color:#ff79c6">+</span> cost
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># Add to response metadata</span>
</span></span><span style="display:flex;"><span>        metadata[<span style="color:#f1fa8c">&#34;cost&#34;</span>] <span style="color:#ff79c6">=</span> cost
</span></span><span style="display:flex;"><span>        metadata[<span style="color:#f1fa8c">&#34;remaining_budget&#34;</span>] <span style="color:#ff79c6">=</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>budget_per_user <span style="color:#ff79c6">-</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>costs[user_id]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> response
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">_calculate_cost</span>(<span style="font-style:italic">self</span>, tokens: <span style="color:#8be9fd;font-style:italic">dict</span>) <span style="color:#ff79c6">-&gt;</span> <span style="color:#8be9fd;font-style:italic">float</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;&#34;&#34;Calculate cost based on token usage&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># GPT-4 pricing (example)</span>
</span></span><span style="display:flex;"><span>        input_cost <span style="color:#ff79c6">=</span> tokens<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#34;prompt_tokens&#34;</span>, <span style="color:#bd93f9">0</span>) <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">0.00003</span>
</span></span><span style="display:flex;"><span>        output_cost <span style="color:#ff79c6">=</span> tokens<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#34;completion_tokens&#34;</span>, <span style="color:#bd93f9">0</span>) <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">0.00006</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> input_cost <span style="color:#ff79c6">+</span> output_cost
</span></span></code></pre></div><h4 id="3-context-window-management">3. Context Window Management</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">class</span> <span style="color:#50fa7b">SmartSummarizationMiddleware</span>(BaseMiddleware):
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;&#34;&#34;Intelligently manage context length&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">__init__</span>(<span style="font-style:italic">self</span>, max_tokens: <span style="color:#8be9fd;font-style:italic">int</span> <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">4000</span>):
</span></span><span style="display:flex;"><span>        <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>max_tokens <span style="color:#ff79c6">=</span> max_tokens
</span></span><span style="display:flex;"><span>        <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>summarizer <span style="color:#ff79c6">=</span> ChatOpenAI(model<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;gpt-3.5-turbo&#34;</span>)  <span style="color:#6272a4"># Cheaper model for summaries</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">pre_process</span>(<span style="font-style:italic">self</span>, messages, metadata):
</span></span><span style="display:flex;"><span>        token_count <span style="color:#ff79c6">=</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>_count_tokens(messages)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> token_count <span style="color:#ff79c6">&lt;=</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>max_tokens:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> messages
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># Keep system message and recent messages</span>
</span></span><span style="display:flex;"><span>        system_msg <span style="color:#ff79c6">=</span> messages[<span style="color:#bd93f9">0</span>] <span style="color:#ff79c6">if</span> messages[<span style="color:#bd93f9">0</span>]<span style="color:#ff79c6">.</span>type <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#34;system&#34;</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">None</span>
</span></span><span style="display:flex;"><span>        recent_msgs <span style="color:#ff79c6">=</span> messages[<span style="color:#ff79c6">-</span><span style="color:#bd93f9">5</span>:]  <span style="color:#6272a4"># Keep last 5 exchanges</span>
</span></span><span style="display:flex;"><span>        old_msgs <span style="color:#ff79c6">=</span> messages[<span style="color:#bd93f9">1</span>:<span style="color:#ff79c6">-</span><span style="color:#bd93f9">5</span>] <span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">len</span>(messages) <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">6</span> <span style="color:#ff79c6">else</span> []
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> old_msgs:
</span></span><span style="display:flex;"><span>            <span style="color:#6272a4"># Summarize old conversation</span>
</span></span><span style="display:flex;"><span>            summary <span style="color:#ff79c6">=</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>_generate_summary(old_msgs)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> [
</span></span><span style="display:flex;"><span>                system_msg,
</span></span><span style="display:flex;"><span>                SystemMessage(content<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;[Previous conversation summary: </span><span style="color:#f1fa8c">{</span>summary<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">]&#34;</span>),
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">*</span>recent_msgs
</span></span><span style="display:flex;"><span>            ]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> messages
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">_generate_summary</span>(<span style="font-style:italic">self</span>, messages: List[BaseMessage]) <span style="color:#ff79c6">-&gt;</span> <span style="color:#8be9fd;font-style:italic">str</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;&#34;&#34;Generate conversation summary&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        conversation_text <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span><span style="color:#ff79c6">.</span>join([
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">{</span>msg<span style="color:#ff79c6">.</span>type<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">: </span><span style="color:#f1fa8c">{</span>msg<span style="color:#ff79c6">.</span>content<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#ff79c6">for</span> msg <span style="color:#ff79c6">in</span> messages
</span></span><span style="display:flex;"><span>        ])
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        summary_prompt <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;&#34;&#34;Summarize this conversation concisely, 
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        preserving key facts and context:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        </span><span style="color:#f1fa8c">{</span>conversation_text<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        Summary:&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>summarizer<span style="color:#ff79c6">.</span>invoke(summary_prompt)<span style="color:#ff79c6">.</span>content
</span></span></code></pre></div><h3 id="composing-middleware">Composing Middleware</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4"># Production middleware stack</span>
</span></span><span style="display:flex;"><span>agent <span style="color:#ff79c6">=</span> create_agent(
</span></span><span style="display:flex;"><span>    model<span style="color:#ff79c6">=</span>ChatOpenAI(model<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;gpt-4&#34;</span>),
</span></span><span style="display:flex;"><span>    tools<span style="color:#ff79c6">=</span>tools,
</span></span><span style="display:flex;"><span>    middleware<span style="color:#ff79c6">=</span>[
</span></span><span style="display:flex;"><span>        PIIMiddleware(mode<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;redact&#34;</span>),           <span style="color:#6272a4"># 1. Security first</span>
</span></span><span style="display:flex;"><span>        CostTrackingMiddleware(budget<span style="color:#ff79c6">=</span><span style="color:#bd93f9">50.0</span>),    <span style="color:#6272a4"># 2. Cost control</span>
</span></span><span style="display:flex;"><span>        LoggingMiddleware(log_level<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;INFO&#34;</span>),    <span style="color:#6272a4"># 3. Observability</span>
</span></span><span style="display:flex;"><span>        SmartSummarizationMiddleware(),         <span style="color:#6272a4"># 4. Context management</span>
</span></span><span style="display:flex;"><span>        HumanInTheLoopMiddleware(               <span style="color:#6272a4"># 5. Compliance</span>
</span></span><span style="display:flex;"><span>            approval_required<span style="color:#ff79c6">=</span>[<span style="color:#f1fa8c">&#34;delete&#34;</span>, <span style="color:#f1fa8c">&#34;update&#34;</span>]
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    checkpointer<span style="color:#ff79c6">=</span>PostgresSaver<span style="color:#ff79c6">.</span>from_conn_string(os<span style="color:#ff79c6">.</span>getenv(<span style="color:#f1fa8c">&#34;DB_URL&#34;</span>))
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p><strong>Execution Order:</strong></p>
<pre tabindex="0"><code>Request:  Input → PII → Cost → Log → Summary → HITL → LLM
Response: LLM → HITL → Summary → Log → Cost → PII → Output
</code></pre><hr>
<h2 id="part-5-operational-excellence">Part 5: Operational Excellence</h2>
<h3 id="observability-the-production-necessity">Observability: The Production Necessity</h3>
<h4 id="langsmith-integration">LangSmith Integration</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> os
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Enable LangSmith tracing</span>
</span></span><span style="display:flex;"><span>os<span style="color:#ff79c6">.</span>environ[<span style="color:#f1fa8c">&#34;LANGCHAIN_TRACING_V2&#34;</span>] <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>os<span style="color:#ff79c6">.</span>environ[<span style="color:#f1fa8c">&#34;LANGCHAIN_API_KEY&#34;</span>] <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;your-api-key&#34;</span>
</span></span><span style="display:flex;"><span>os<span style="color:#ff79c6">.</span>environ[<span style="color:#f1fa8c">&#34;LANGCHAIN_PROJECT&#34;</span>] <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;production-agents&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># All agent executions automatically traced</span>
</span></span><span style="display:flex;"><span>agent <span style="color:#ff79c6">=</span> create_agent(model<span style="color:#ff79c6">=</span>model, tools<span style="color:#ff79c6">=</span>tools)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># View traces at smith.langchain.com</span>
</span></span></code></pre></div><p><strong>What You Get:</strong></p>
<ul>
<li>Complete execution traces</li>
<li>Token usage and costs</li>
<li>Tool calls and results</li>
<li>Error stack traces</li>
<li>Performance metrics</li>
<li>User feedback collection</li>
</ul>
<h4 id="custom-metrics">Custom Metrics</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">from</span> langchain_core.callbacks <span style="color:#ff79c6">import</span> BaseCallbackHandler
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> prometheus_client <span style="color:#ff79c6">import</span> Counter, Histogram
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">class</span> <span style="color:#50fa7b">MetricsCallback</span>(BaseCallbackHandler):
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;&#34;&#34;Export metrics to Prometheus&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">__init__</span>(<span style="font-style:italic">self</span>):
</span></span><span style="display:flex;"><span>        <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>llm_calls <span style="color:#ff79c6">=</span> Counter(<span style="color:#f1fa8c">&#39;agent_llm_calls_total&#39;</span>, <span style="color:#f1fa8c">&#39;Total LLM calls&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>tool_calls <span style="color:#ff79c6">=</span> Counter(<span style="color:#f1fa8c">&#39;agent_tool_calls_total&#39;</span>, <span style="color:#f1fa8c">&#39;Total tool calls&#39;</span>, [<span style="color:#f1fa8c">&#39;tool_name&#39;</span>])
</span></span><span style="display:flex;"><span>        <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>latency <span style="color:#ff79c6">=</span> Histogram(<span style="color:#f1fa8c">&#39;agent_latency_seconds&#39;</span>, <span style="color:#f1fa8c">&#39;Agent response latency&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>errors <span style="color:#ff79c6">=</span> Counter(<span style="color:#f1fa8c">&#39;agent_errors_total&#39;</span>, <span style="color:#f1fa8c">&#39;Total errors&#39;</span>, [<span style="color:#f1fa8c">&#39;error_type&#39;</span>])
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">on_llm_start</span>(<span style="font-style:italic">self</span>, serialized, prompts, <span style="color:#ff79c6">**</span>kwargs):
</span></span><span style="display:flex;"><span>        <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>llm_calls<span style="color:#ff79c6">.</span>inc()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">on_tool_start</span>(<span style="font-style:italic">self</span>, serialized, input_str, <span style="color:#ff79c6">**</span>kwargs):
</span></span><span style="display:flex;"><span>        tool_name <span style="color:#ff79c6">=</span> serialized<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#34;name&#34;</span>, <span style="color:#f1fa8c">&#34;unknown&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>tool_calls<span style="color:#ff79c6">.</span>labels(tool_name<span style="color:#ff79c6">=</span>tool_name)<span style="color:#ff79c6">.</span>inc()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">on_llm_error</span>(<span style="font-style:italic">self</span>, error, <span style="color:#ff79c6">**</span>kwargs):
</span></span><span style="display:flex;"><span>        error_type <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">type</span>(error)<span style="color:#ff79c6">.</span><span style="color:#8be9fd;font-style:italic">__name__</span>
</span></span><span style="display:flex;"><span>        <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>errors<span style="color:#ff79c6">.</span>labels(error_type<span style="color:#ff79c6">=</span>error_type)<span style="color:#ff79c6">.</span>inc()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Use in agent</span>
</span></span><span style="display:flex;"><span>metrics <span style="color:#ff79c6">=</span> MetricsCallback()
</span></span><span style="display:flex;"><span>agent <span style="color:#ff79c6">=</span> create_agent(
</span></span><span style="display:flex;"><span>    model<span style="color:#ff79c6">=</span>ChatOpenAI(model<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;gpt-4&#34;</span>, callbacks<span style="color:#ff79c6">=</span>[metrics]),
</span></span><span style="display:flex;"><span>    tools<span style="color:#ff79c6">=</span>tools
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><h3 id="deployment-architectures">Deployment Architectures</h3>
<h4 id="option-1-langserve-recommended">Option 1: LangServe (Recommended)</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">from</span> fastapi <span style="color:#ff79c6">import</span> FastAPI
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> langserve <span style="color:#ff79c6">import</span> add_routes
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> langchain <span style="color:#ff79c6">import</span> create_agent
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>app <span style="color:#ff79c6">=</span> FastAPI(
</span></span><span style="display:flex;"><span>    title<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;Agent API&#34;</span>,
</span></span><span style="display:flex;"><span>    version<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;1.0&#34;</span>,
</span></span><span style="display:flex;"><span>    description<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;Production agent API&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Create agent</span>
</span></span><span style="display:flex;"><span>agent <span style="color:#ff79c6">=</span> create_agent(
</span></span><span style="display:flex;"><span>    model<span style="color:#ff79c6">=</span>ChatOpenAI(model<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;gpt-4&#34;</span>),
</span></span><span style="display:flex;"><span>    tools<span style="color:#ff79c6">=</span>tools,
</span></span><span style="display:flex;"><span>    checkpointer<span style="color:#ff79c6">=</span>PostgresSaver<span style="color:#ff79c6">.</span>from_conn_string(os<span style="color:#ff79c6">.</span>getenv(<span style="color:#f1fa8c">&#34;DB_URL&#34;</span>))
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Add routes</span>
</span></span><span style="display:flex;"><span>add_routes(
</span></span><span style="display:flex;"><span>    app,
</span></span><span style="display:flex;"><span>    agent,
</span></span><span style="display:flex;"><span>    path<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;/agent&#34;</span>,
</span></span><span style="display:flex;"><span>    enabled_endpoints<span style="color:#ff79c6">=</span>[<span style="color:#f1fa8c">&#34;invoke&#34;</span>, <span style="color:#f1fa8c">&#34;stream&#34;</span>, <span style="color:#f1fa8c">&#34;batch&#34;</span>],
</span></span><span style="display:flex;"><span>    playground_type<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;chat&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Health check</span>
</span></span><span style="display:flex;"><span>@app.get(<span style="color:#f1fa8c">&#34;/health&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">health_check</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> {<span style="color:#f1fa8c">&#34;status&#34;</span>: <span style="color:#f1fa8c">&#34;healthy&#34;</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Run with: uvicorn main:app --host 0.0.0.0 --port 8000 --workers 4</span>
</span></span></code></pre></div><h4 id="option-2-containerized-deployment">Option 2: Containerized Deployment</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#6272a4"># Dockerfile</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">FROM</span> <span style="color:#f1fa8c">python:3.11-slim</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">WORKDIR</span> <span style="color:#f1fa8c">/app</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Install dependencies</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">COPY</span> requirements.txt .
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">RUN</span> pip install --no-cache-dir -r requirements.txt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Copy application</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">COPY</span> . .
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Non-root user</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">RUN</span> useradd -m -u <span style="color:#bd93f9">1000</span> agent <span style="color:#ff79c6">&amp;&amp;</span> chown -R agent:agent /app
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">USER</span> <span style="color:#f1fa8c">agent</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Health check</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">HEALTHCHECK</span> --interval<span style="color:#ff79c6">=</span>30s --timeout<span style="color:#ff79c6">=</span>10s --start-period<span style="color:#ff79c6">=</span>5s --retries<span style="color:#ff79c6">=</span><span style="color:#bd93f9">3</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    CMD curl -f http://localhost:8000/health <span style="color:#ff79c6">||</span> <span style="color:#8be9fd;font-style:italic">exit</span> <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">EXPOSE</span> <span style="color:#f1fa8c">8000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">CMD</span> [<span style="color:#f1fa8c">&#34;uvicorn&#34;</span>, <span style="color:#f1fa8c">&#34;main:app&#34;</span>, <span style="color:#f1fa8c">&#34;--host&#34;</span>, <span style="color:#f1fa8c">&#34;0.0.0.0&#34;</span>, <span style="color:#f1fa8c">&#34;--port&#34;</span>, <span style="color:#f1fa8c">&#34;8000&#34;</span>]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># docker-compose.yml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">version</span>: <span style="color:#f1fa8c">&#39;3.8&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">services</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">agent</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">build</span>: .
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f1fa8c">&#34;8000:8000&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">environment</span>:
</span></span><span style="display:flex;"><span>      - OPENAI_API_KEY=${OPENAI_API_KEY}
</span></span><span style="display:flex;"><span>      - DATABASE_URL=postgresql://user:pass@db:5432/langchain
</span></span><span style="display:flex;"><span>      - LANGCHAIN_TRACING_V2=true
</span></span><span style="display:flex;"><span>      - LANGCHAIN_API_KEY=${LANGCHAIN_API_KEY}
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">depends_on</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">db</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">condition</span>: service_healthy
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">restart</span>: unless-stopped
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">deploy</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">resources</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">limits</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">cpus</span>: <span style="color:#f1fa8c">&#39;2&#39;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">memory</span>: 2G
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">db</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">image</span>: postgres:15-alpine
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">environment</span>:
</span></span><span style="display:flex;"><span>      - POSTGRES_USER=user
</span></span><span style="display:flex;"><span>      - POSTGRES_PASSWORD=pass
</span></span><span style="display:flex;"><span>      - POSTGRES_DB=langchain
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">volumes</span>:
</span></span><span style="display:flex;"><span>      - pgdata:/var/lib/postgresql/data
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">healthcheck</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">test</span>: [<span style="color:#f1fa8c">&#34;CMD-SHELL&#34;</span>, <span style="color:#f1fa8c">&#34;pg_isready -U user&#34;</span>]
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">interval</span>: 10s
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">timeout</span>: 5s
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">retries</span>: <span style="color:#bd93f9">5</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">redis</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">image</span>: redis:7-alpine
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">healthcheck</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">test</span>: [<span style="color:#f1fa8c">&#34;CMD&#34;</span>, <span style="color:#f1fa8c">&#34;redis-cli&#34;</span>, <span style="color:#f1fa8c">&#34;ping&#34;</span>]
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">interval</span>: 10s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">volumes</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">pgdata</span>:
</span></span></code></pre></div><h4 id="option-3-kubernetes-deployment">Option 3: Kubernetes Deployment</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># k8s/deployment.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: apps/v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Deployment
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: langchain-agent
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">replicas</span>: <span style="color:#bd93f9">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">app</span>: langchain-agent
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">app</span>: langchain-agent
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff79c6">name</span>: agent
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">image</span>: your-registry/langchain-agent:latest
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">containerPort</span>: <span style="color:#bd93f9">8000</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">env</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">name</span>: DATABASE_URL
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">valueFrom</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">secretKeyRef</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">name</span>: agent-secrets
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">key</span>: database-url
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">name</span>: OPENAI_API_KEY
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">valueFrom</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">secretKeyRef</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">name</span>: agent-secrets
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">key</span>: openai-api-key
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">resources</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">requests</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">memory</span>: <span style="color:#f1fa8c">&#34;1Gi&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">cpu</span>: <span style="color:#f1fa8c">&#34;500m&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">limits</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">memory</span>: <span style="color:#f1fa8c">&#34;2Gi&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">cpu</span>: <span style="color:#f1fa8c">&#34;1000m&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">livenessProbe</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">httpGet</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">path</span>: /health
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">port</span>: <span style="color:#bd93f9">8000</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">initialDelaySeconds</span>: <span style="color:#bd93f9">30</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">periodSeconds</span>: <span style="color:#bd93f9">10</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">readinessProbe</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">httpGet</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">path</span>: /health
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">port</span>: <span style="color:#bd93f9">8000</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">initialDelaySeconds</span>: <span style="color:#bd93f9">5</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">periodSeconds</span>: <span style="color:#bd93f9">5</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Service
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: langchain-agent
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: langchain-agent
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff79c6">protocol</span>: TCP
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">port</span>: <span style="color:#bd93f9">80</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">targetPort</span>: <span style="color:#bd93f9">8000</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">type</span>: LoadBalancer
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: autoscaling/v2
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: HorizontalPodAutoscaler
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: langchain-agent-hpa
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">scaleTargetRef</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">apiVersion</span>: apps/v1
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">kind</span>: Deployment
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">name</span>: langchain-agent
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">minReplicas</span>: <span style="color:#bd93f9">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">maxReplicas</span>: <span style="color:#bd93f9">10</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">metrics</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff79c6">type</span>: Resource
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">resource</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">name</span>: cpu
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">target</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">type</span>: Utilization
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">averageUtilization</span>: <span style="color:#bd93f9">70</span>
</span></span></code></pre></div><hr>
<h2 id="part-6-performance--cost-optimization">Part 6: Performance &amp; Cost Optimization</h2>
<h3 id="strategy-1-model-routing">Strategy 1: Model Routing</h3>
<p>Route requests to appropriate models based on complexity:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">class</span> <span style="color:#50fa7b">ModelRouter</span>(BaseMiddleware):
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;&#34;&#34;Route to appropriate model based on complexity&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">__init__</span>(<span style="font-style:italic">self</span>):
</span></span><span style="display:flex;"><span>        <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>cheap_model <span style="color:#ff79c6">=</span> ChatOpenAI(model<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;gpt-3.5-turbo&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>expensive_model <span style="color:#ff79c6">=</span> ChatOpenAI(model<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;gpt-4&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>complexity_classifier <span style="color:#ff79c6">=</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>_train_classifier()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">pre_process</span>(<span style="font-style:italic">self</span>, messages, metadata):
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># Classify query complexity</span>
</span></span><span style="display:flex;"><span>        last_message <span style="color:#ff79c6">=</span> messages[<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>]<span style="color:#ff79c6">.</span>content
</span></span><span style="display:flex;"><span>        complexity <span style="color:#ff79c6">=</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>complexity_classifier<span style="color:#ff79c6">.</span>predict(last_message)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> complexity <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#34;simple&#34;</span>:
</span></span><span style="display:flex;"><span>            metadata[<span style="color:#f1fa8c">&#34;model_override&#34;</span>] <span style="color:#ff79c6">=</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>cheap_model
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">else</span>:
</span></span><span style="display:flex;"><span>            metadata[<span style="color:#f1fa8c">&#34;model_override&#34;</span>] <span style="color:#ff79c6">=</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>expensive_model
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> messages
</span></span></code></pre></div><h3 id="strategy-2-caching">Strategy 2: Caching</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">from</span> langchain.cache <span style="color:#ff79c6">import</span> SQLiteCache
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> langchain_core.globals <span style="color:#ff79c6">import</span> set_llm_cache
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Enable semantic caching</span>
</span></span><span style="display:flex;"><span>set_llm_cache(SQLiteCache(database_path<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;.langchain.db&#34;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Cache hits are free!</span>
</span></span><span style="display:flex;"><span>model <span style="color:#ff79c6">=</span> ChatOpenAI(model<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;gpt-4&#34;</span>, cache<span style="color:#ff79c6">=</span><span style="color:#ff79c6">True</span>)
</span></span></code></pre></div><h3 id="strategy-3-batch-processing">Strategy 3: Batch Processing</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4"># Process multiple requests in one batch</span>
</span></span><span style="display:flex;"><span>inputs <span style="color:#ff79c6">=</span> [
</span></span><span style="display:flex;"><span>    {<span style="color:#f1fa8c">&#34;messages&#34;</span>: [{<span style="color:#f1fa8c">&#34;role&#34;</span>: <span style="color:#f1fa8c">&#34;user&#34;</span>, <span style="color:#f1fa8c">&#34;content&#34;</span>: query}]}
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> query <span style="color:#ff79c6">in</span> user_queries
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Batch invoke (more efficient)</span>
</span></span><span style="display:flex;"><span>results <span style="color:#ff79c6">=</span> agent<span style="color:#ff79c6">.</span>batch(
</span></span><span style="display:flex;"><span>    inputs,
</span></span><span style="display:flex;"><span>    config<span style="color:#ff79c6">=</span>{<span style="color:#f1fa8c">&#34;max_concurrency&#34;</span>: <span style="color:#bd93f9">5</span>}
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><h3 id="cost-analysis-dashboard">Cost Analysis Dashboard</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">class</span> <span style="color:#50fa7b">CostAnalyzer</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;&#34;&#34;Analyze agent costs and optimize&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">generate_report</span>(<span style="font-style:italic">self</span>, timeframe: <span style="color:#8be9fd;font-style:italic">str</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;24h&#34;</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;&#34;&#34;Generate cost report&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        costs <span style="color:#ff79c6">=</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>_query_costs(timeframe)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;total_cost&#34;</span>: costs[<span style="color:#f1fa8c">&#34;total&#34;</span>],
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;cost_by_model&#34;</span>: costs[<span style="color:#f1fa8c">&#34;by_model&#34;</span>],
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;cost_by_user&#34;</span>: costs[<span style="color:#f1fa8c">&#34;by_user&#34;</span>],
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;cost_by_tool&#34;</span>: costs[<span style="color:#f1fa8c">&#34;by_tool&#34;</span>],
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;recommendations&#34;</span>: <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>_generate_recommendations(costs)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">_generate_recommendations</span>(<span style="font-style:italic">self</span>, costs):
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;&#34;&#34;Generate optimization recommendations&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        recommendations <span style="color:#ff79c6">=</span> []
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># Check if GPT-4 is overused</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> costs[<span style="color:#f1fa8c">&#34;by_model&#34;</span>]<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#34;gpt-4&#34;</span>, <span style="color:#bd93f9">0</span>) <span style="color:#ff79c6">&gt;</span> costs[<span style="color:#f1fa8c">&#34;total&#34;</span>] <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">0.8</span>:
</span></span><span style="display:flex;"><span>            recommendations<span style="color:#ff79c6">.</span>append({
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#34;type&#34;</span>: <span style="color:#f1fa8c">&#34;model_optimization&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#34;message&#34;</span>: <span style="color:#f1fa8c">&#34;Consider routing simple queries to GPT-3.5-turbo&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#34;potential_savings&#34;</span>: costs[<span style="color:#f1fa8c">&#34;by_model&#34;</span>][<span style="color:#f1fa8c">&#34;gpt-4&#34;</span>] <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">0.3</span>
</span></span><span style="display:flex;"><span>            })
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># Check for redundant tool calls</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> costs[<span style="color:#f1fa8c">&#34;by_tool&#34;</span>]<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#34;redundant_calls&#34;</span>, <span style="color:#bd93f9">0</span>) <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">100</span>:
</span></span><span style="display:flex;"><span>            recommendations<span style="color:#ff79c6">.</span>append({
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#34;type&#34;</span>: <span style="color:#f1fa8c">&#34;caching&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#34;message&#34;</span>: <span style="color:#f1fa8c">&#34;Enable tool result caching&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#34;potential_savings&#34;</span>: costs[<span style="color:#f1fa8c">&#34;by_tool&#34;</span>][<span style="color:#f1fa8c">&#34;redundant_calls&#34;</span>] <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">0.02</span>
</span></span><span style="display:flex;"><span>            })
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> recommendations
</span></span></code></pre></div><hr>
<h2 id="part-7-security--compliance-considerations">Part 7: Security &amp; Compliance Considerations</h2>
<h3 id="data-privacy-architecture">Data Privacy Architecture</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">class</span> <span style="color:#50fa7b">PrivacyCompliantAgent</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;&#34;&#34;Agent designed for regulated industries&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">__init__</span>(<span style="font-style:italic">self</span>):
</span></span><span style="display:flex;"><span>        <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>agent <span style="color:#ff79c6">=</span> create_agent(
</span></span><span style="display:flex;"><span>            model<span style="color:#ff79c6">=</span>ChatOpenAI(model<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;gpt-4&#34;</span>),
</span></span><span style="display:flex;"><span>            tools<span style="color:#ff79c6">=</span><span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>_get_compliant_tools(),
</span></span><span style="display:flex;"><span>            middleware<span style="color:#ff79c6">=</span>[
</span></span><span style="display:flex;"><span>                PIIMiddleware(mode<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;redact&#34;</span>),
</span></span><span style="display:flex;"><span>                DataResidencyMiddleware(region<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;EU&#34;</span>),
</span></span><span style="display:flex;"><span>                AuditLoggingMiddleware(),
</span></span><span style="display:flex;"><span>                EncryptionMiddleware(key<span style="color:#ff79c6">=</span>os<span style="color:#ff79c6">.</span>getenv(<span style="color:#f1fa8c">&#34;ENCRYPTION_KEY&#34;</span>))
</span></span><span style="display:flex;"><span>            ],
</span></span><span style="display:flex;"><span>            checkpointer<span style="color:#ff79c6">=</span>EncryptedPostgresSaver<span style="color:#ff79c6">.</span>from_conn_string(
</span></span><span style="display:flex;"><span>                os<span style="color:#ff79c6">.</span>getenv(<span style="color:#f1fa8c">&#34;DB_URL&#34;</span>)
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">_get_compliant_tools</span>(<span style="font-style:italic">self</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;&#34;&#34;Tools that meet compliance requirements&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> [
</span></span><span style="display:flex;"><span>            <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>_create_anonymized_search(),
</span></span><span style="display:flex;"><span>            <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>_create_secure_database_access(),
</span></span><span style="display:flex;"><span>            <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>_create_audit_logged_email()
</span></span><span style="display:flex;"><span>        ]
</span></span></code></pre></div><h3 id="key-security-features">Key Security Features</h3>
<ol>
<li><strong>Data Encryption</strong>: All state encrypted at rest</li>
<li><strong>PII Protection</strong>: Automatic detection and redaction</li>
<li><strong>Audit Logging</strong>: Complete trail of all operations</li>
<li><strong>Access Controls</strong>: Role-based tool access</li>
<li><strong>Data Residency</strong>: Control where data is processed</li>
</ol>
<h3 id="compliance-checklist">Compliance Checklist</h3>
<p>For regulated industries (healthcare, finance, government):</p>
<p>✅ <strong>Data Protection</strong></p>
<ul>
<li><input disabled="" type="checkbox"> PII/PHI detection enabled</li>
<li><input disabled="" type="checkbox"> Encryption at rest and in transit</li>
<li><input disabled="" type="checkbox"> Data retention policies implemented</li>
<li><input disabled="" type="checkbox"> Right to deletion supported</li>
</ul>
<p>✅ <strong>Audit &amp; Governance</strong></p>
<ul>
<li><input disabled="" type="checkbox"> Complete audit trail</li>
<li><input disabled="" type="checkbox"> Human-in-the-loop for sensitive operations</li>
<li><input disabled="" type="checkbox"> Version control for prompts</li>
<li><input disabled="" type="checkbox"> Model output monitoring</li>
</ul>
<p>✅ <strong>Security</strong></p>
<ul>
<li><input disabled="" type="checkbox"> API key rotation</li>
<li><input disabled="" type="checkbox"> Rate limiting</li>
<li><input disabled="" type="checkbox"> Input validation</li>
<li><input disabled="" type="checkbox"> Output sanitization</li>
</ul>
<hr>
<h2 id="part-8-testing--quality-assurance">Part 8: Testing &amp; Quality Assurance</h2>
<h3 id="unit-testing-agents">Unit Testing Agents</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> pytest
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> unittest.mock <span style="color:#ff79c6">import</span> Mock, patch
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">class</span> <span style="color:#50fa7b">TestAgentBehavior</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;&#34;&#34;Test suite for agent logic&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    @pytest.fixture
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">mock_model</span>(<span style="font-style:italic">self</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;&#34;&#34;Mock LLM for testing&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        model <span style="color:#ff79c6">=</span> Mock()
</span></span><span style="display:flex;"><span>        model<span style="color:#ff79c6">.</span>invoke<span style="color:#ff79c6">.</span>return_value <span style="color:#ff79c6">=</span> AIMessage(
</span></span><span style="display:flex;"><span>            content<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;Test response&#34;</span>,
</span></span><span style="display:flex;"><span>            tool_calls<span style="color:#ff79c6">=</span>[{
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#34;name&#34;</span>: <span style="color:#f1fa8c">&#34;search&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#34;args&#34;</span>: {<span style="color:#f1fa8c">&#34;query&#34;</span>: <span style="color:#f1fa8c">&#34;test&#34;</span>}
</span></span><span style="display:flex;"><span>            }]
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> model
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    @pytest.fixture
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">agent</span>(<span style="font-style:italic">self</span>, mock_model):
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;&#34;&#34;Create agent with mocked components&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> create_agent(
</span></span><span style="display:flex;"><span>            model<span style="color:#ff79c6">=</span>mock_model,
</span></span><span style="display:flex;"><span>            tools<span style="color:#ff79c6">=</span>[<span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>mock_search_tool()],
</span></span><span style="display:flex;"><span>            checkpointer<span style="color:#ff79c6">=</span>MemorySaver()
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">mock_search_tool</span>(<span style="font-style:italic">self</span>):
</span></span><span style="display:flex;"><span>        @tool
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">mock_search</span>(query: <span style="color:#8be9fd;font-style:italic">str</span>) <span style="color:#ff79c6">-&gt;</span> <span style="color:#8be9fd;font-style:italic">str</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;&#34;&#34;Mock search tool&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;Mock results for: </span><span style="color:#f1fa8c">{</span>query<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> mock_search
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">test_agent_uses_tools</span>(<span style="font-style:italic">self</span>, agent):
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;&#34;&#34;Test that agent correctly uses tools&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        result <span style="color:#ff79c6">=</span> agent<span style="color:#ff79c6">.</span>invoke(
</span></span><span style="display:flex;"><span>            {<span style="color:#f1fa8c">&#34;messages&#34;</span>: [{<span style="color:#f1fa8c">&#34;role&#34;</span>: <span style="color:#f1fa8c">&#34;user&#34;</span>, <span style="color:#f1fa8c">&#34;content&#34;</span>: <span style="color:#f1fa8c">&#34;Search for AI&#34;</span>}]},
</span></span><span style="display:flex;"><span>            {<span style="color:#f1fa8c">&#34;configurable&#34;</span>: {<span style="color:#f1fa8c">&#34;thread_id&#34;</span>: <span style="color:#f1fa8c">&#34;test&#34;</span>}}
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># Verify tool was called</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">assert</span> <span style="color:#f1fa8c">&#34;Mock results&#34;</span> <span style="color:#ff79c6">in</span> <span style="color:#8be9fd;font-style:italic">str</span>(result)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">test_agent_handles_errors</span>(<span style="font-style:italic">self</span>, agent):
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;&#34;&#34;Test error handling&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">with</span> patch<span style="color:#ff79c6">.</span>object(agent, <span style="color:#f1fa8c">&#39;invoke&#39;</span>, side_effect<span style="color:#ff79c6">=</span>Exception(<span style="color:#f1fa8c">&#34;Test error&#34;</span>)):
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">with</span> pytest<span style="color:#ff79c6">.</span>raises(Exception):
</span></span><span style="display:flex;"><span>                agent<span style="color:#ff79c6">.</span>invoke({<span style="color:#f1fa8c">&#34;messages&#34;</span>: []})
</span></span></code></pre></div><h3 id="integration-testing">Integration Testing</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">class</span> <span style="color:#50fa7b">TestRAGPipeline</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;&#34;&#34;Integration tests for RAG system&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    @pytest.fixture
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">rag_system</span>(<span style="font-style:italic">self</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;&#34;&#34;Set up real RAG system for integration tests&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># Use test index</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> RAGSystem(index_name<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;test-index&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">test_end_to_end_query</span>(<span style="font-style:italic">self</span>, rag_system):
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;&#34;&#34;Test complete RAG flow&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        response <span style="color:#ff79c6">=</span> rag_system<span style="color:#ff79c6">.</span>query(
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;What is the return policy?&#34;</span>,
</span></span><span style="display:flex;"><span>            thread_id<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;integration_test&#34;</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># Verify response quality</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">assert</span> <span style="color:#8be9fd;font-style:italic">len</span>(response) <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">assert</span> <span style="color:#f1fa8c">&#34;return&#34;</span> <span style="color:#ff79c6">in</span> response<span style="color:#ff79c6">.</span>lower()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    @pytest.mark.slow
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">test_concurrent_queries</span>(<span style="font-style:italic">self</span>, rag_system):
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;&#34;&#34;Test system under load&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">import</span> concurrent.futures
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        queries <span style="color:#ff79c6">=</span> [<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;Test query </span><span style="color:#f1fa8c">{</span>i<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> <span style="color:#8be9fd;font-style:italic">range</span>(<span style="color:#bd93f9">100</span>)]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">with</span> concurrent<span style="color:#ff79c6">.</span>futures<span style="color:#ff79c6">.</span>ThreadPoolExecutor(max_workers<span style="color:#ff79c6">=</span><span style="color:#bd93f9">10</span>) <span style="color:#ff79c6">as</span> executor:
</span></span><span style="display:flex;"><span>            futures <span style="color:#ff79c6">=</span> [
</span></span><span style="display:flex;"><span>                executor<span style="color:#ff79c6">.</span>submit(
</span></span><span style="display:flex;"><span>                    rag_system<span style="color:#ff79c6">.</span>query, 
</span></span><span style="display:flex;"><span>                    query, 
</span></span><span style="display:flex;"><span>                    <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;thread_</span><span style="color:#f1fa8c">{</span>i<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>                )
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">for</span> i, query <span style="color:#ff79c6">in</span> <span style="color:#8be9fd;font-style:italic">enumerate</span>(queries)
</span></span><span style="display:flex;"><span>            ]
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            results <span style="color:#ff79c6">=</span> [f<span style="color:#ff79c6">.</span>result() <span style="color:#ff79c6">for</span> f <span style="color:#ff79c6">in</span> futures]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># All queries should succeed</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">assert</span> <span style="color:#8be9fd;font-style:italic">len</span>(results) <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">100</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">assert</span> <span style="color:#8be9fd;font-style:italic">all</span>(<span style="color:#8be9fd;font-style:italic">len</span>(r) <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">0</span> <span style="color:#ff79c6">for</span> r <span style="color:#ff79c6">in</span> results)
</span></span></code></pre></div><h3 id="evaluation-framework">Evaluation Framework</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">from</span> langchain.evaluation <span style="color:#ff79c6">import</span> load_evaluator
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">class</span> <span style="color:#50fa7b">AgentEvaluator</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;&#34;&#34;Evaluate agent quality&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">__init__</span>(<span style="font-style:italic">self</span>):
</span></span><span style="display:flex;"><span>        <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>criteria_evaluator <span style="color:#ff79c6">=</span> load_evaluator(<span style="color:#f1fa8c">&#34;criteria&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>qa_evaluator <span style="color:#ff79c6">=</span> load_evaluator(<span style="color:#f1fa8c">&#34;qa&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">evaluate_helpfulness</span>(<span style="font-style:italic">self</span>, query: <span style="color:#8be9fd;font-style:italic">str</span>, response: <span style="color:#8be9fd;font-style:italic">str</span>) <span style="color:#ff79c6">-&gt;</span> <span style="color:#8be9fd;font-style:italic">float</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;&#34;&#34;Evaluate response helpfulness&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        result <span style="color:#ff79c6">=</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>criteria_evaluator<span style="color:#ff79c6">.</span>evaluate_strings(
</span></span><span style="display:flex;"><span>            prediction<span style="color:#ff79c6">=</span>response,
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">input</span><span style="color:#ff79c6">=</span>query,
</span></span><span style="display:flex;"><span>            criteria<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;helpfulness&#34;</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> result[<span style="color:#f1fa8c">&#34;score&#34;</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">evaluate_accuracy</span>(
</span></span><span style="display:flex;"><span>        <span style="font-style:italic">self</span>, 
</span></span><span style="display:flex;"><span>        query: <span style="color:#8be9fd;font-style:italic">str</span>, 
</span></span><span style="display:flex;"><span>        response: <span style="color:#8be9fd;font-style:italic">str</span>, 
</span></span><span style="display:flex;"><span>        reference: <span style="color:#8be9fd;font-style:italic">str</span>
</span></span><span style="display:flex;"><span>    ) <span style="color:#ff79c6">-&gt;</span> <span style="color:#8be9fd;font-style:italic">float</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;&#34;&#34;Evaluate response accuracy&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        result <span style="color:#ff79c6">=</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>qa_evaluator<span style="color:#ff79c6">.</span>evaluate_strings(
</span></span><span style="display:flex;"><span>            prediction<span style="color:#ff79c6">=</span>response,
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">input</span><span style="color:#ff79c6">=</span>query,
</span></span><span style="display:flex;"><span>            reference<span style="color:#ff79c6">=</span>reference
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> result[<span style="color:#f1fa8c">&#34;score&#34;</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">run_evaluation_suite</span>(<span style="font-style:italic">self</span>, agent, test_cases: <span style="color:#8be9fd;font-style:italic">list</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;&#34;&#34;Run comprehensive evaluation&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        results <span style="color:#ff79c6">=</span> []
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">for</span> test_case <span style="color:#ff79c6">in</span> test_cases:
</span></span><span style="display:flex;"><span>            response <span style="color:#ff79c6">=</span> agent<span style="color:#ff79c6">.</span>invoke(
</span></span><span style="display:flex;"><span>                {<span style="color:#f1fa8c">&#34;messages&#34;</span>: [{<span style="color:#f1fa8c">&#34;role&#34;</span>: <span style="color:#f1fa8c">&#34;user&#34;</span>, <span style="color:#f1fa8c">&#34;content&#34;</span>: test_case[<span style="color:#f1fa8c">&#34;query&#34;</span>]}]},
</span></span><span style="display:flex;"><span>                {<span style="color:#f1fa8c">&#34;configurable&#34;</span>: {<span style="color:#f1fa8c">&#34;thread_id&#34;</span>: <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;eval_</span><span style="color:#f1fa8c">{</span>test_case[<span style="color:#f1fa8c">&#39;id&#39;</span>]<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>}}
</span></span><span style="display:flex;"><span>            )[<span style="color:#f1fa8c">&#34;messages&#34;</span>][<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>]<span style="color:#ff79c6">.</span>content
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            results<span style="color:#ff79c6">.</span>append({
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#34;test_id&#34;</span>: test_case[<span style="color:#f1fa8c">&#34;id&#34;</span>],
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#34;query&#34;</span>: test_case[<span style="color:#f1fa8c">&#34;query&#34;</span>],
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#34;response&#34;</span>: response,
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#34;helpfulness&#34;</span>: <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>evaluate_helpfulness(
</span></span><span style="display:flex;"><span>                    test_case[<span style="color:#f1fa8c">&#34;query&#34;</span>], 
</span></span><span style="display:flex;"><span>                    response
</span></span><span style="display:flex;"><span>                ),
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#34;accuracy&#34;</span>: <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>evaluate_accuracy(
</span></span><span style="display:flex;"><span>                    test_case[<span style="color:#f1fa8c">&#34;query&#34;</span>],
</span></span><span style="display:flex;"><span>                    response,
</span></span><span style="display:flex;"><span>                    test_case[<span style="color:#f1fa8c">&#34;expected_answer&#34;</span>]
</span></span><span style="display:flex;"><span>                )
</span></span><span style="display:flex;"><span>            })
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>_generate_report(results)
</span></span></code></pre></div><hr>
<h2 id="part-9-migration-guide-0x--1x">Part 9: Migration Guide: 0.x → 1.x</h2>
<h3 id="key-breaking-changes">Key Breaking Changes</h3>
<p><strong>1. Agent Initialization</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4"># OLD (0.x)</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> langchain.agents <span style="color:#ff79c6">import</span> initialize_agent, AgentType
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> langchain.memory <span style="color:#ff79c6">import</span> ConversationBufferMemory
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>memory <span style="color:#ff79c6">=</span> ConversationBufferMemory()
</span></span><span style="display:flex;"><span>agent <span style="color:#ff79c6">=</span> initialize_agent(
</span></span><span style="display:flex;"><span>    tools<span style="color:#ff79c6">=</span>tools,
</span></span><span style="display:flex;"><span>    llm<span style="color:#ff79c6">=</span>llm,
</span></span><span style="display:flex;"><span>    agent<span style="color:#ff79c6">=</span>AgentType<span style="color:#ff79c6">.</span>CHAT_CONVERSATIONAL_REACT_DESCRIPTION,
</span></span><span style="display:flex;"><span>    memory<span style="color:#ff79c6">=</span>memory,
</span></span><span style="display:flex;"><span>    verbose<span style="color:#ff79c6">=</span><span style="color:#ff79c6">True</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>result <span style="color:#ff79c6">=</span> agent<span style="color:#ff79c6">.</span>run(<span style="color:#f1fa8c">&#34;Hello&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># NEW (1.x)</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> langchain <span style="color:#ff79c6">import</span> create_agent
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> langgraph.checkpoint.sqlite <span style="color:#ff79c6">import</span> SqliteSaver
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>agent <span style="color:#ff79c6">=</span> create_agent(
</span></span><span style="display:flex;"><span>    model<span style="color:#ff79c6">=</span>llm,  <span style="color:#6272a4"># Changed from &#39;llm&#39; to &#39;model&#39;</span>
</span></span><span style="display:flex;"><span>    tools<span style="color:#ff79c6">=</span>tools,
</span></span><span style="display:flex;"><span>    prompt<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;You are a helpful assistant&#34;</span>,
</span></span><span style="display:flex;"><span>    checkpointer<span style="color:#ff79c6">=</span>SqliteSaver<span style="color:#ff79c6">.</span>from_conn_string(<span style="color:#f1fa8c">&#34;:memory:&#34;</span>)
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>result <span style="color:#ff79c6">=</span> agent<span style="color:#ff79c6">.</span>invoke(
</span></span><span style="display:flex;"><span>    {<span style="color:#f1fa8c">&#34;messages&#34;</span>: [{<span style="color:#f1fa8c">&#34;role&#34;</span>: <span style="color:#f1fa8c">&#34;user&#34;</span>, <span style="color:#f1fa8c">&#34;content&#34;</span>: <span style="color:#f1fa8c">&#34;Hello&#34;</span>}]},
</span></span><span style="display:flex;"><span>    {<span style="color:#f1fa8c">&#34;configurable&#34;</span>: {<span style="color:#f1fa8c">&#34;thread_id&#34;</span>: <span style="color:#f1fa8c">&#34;session_1&#34;</span>}}
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p><strong>2. Chain Construction</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4"># OLD (0.x)</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> langchain.chains <span style="color:#ff79c6">import</span> LLMChain
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>chain <span style="color:#ff79c6">=</span> LLMChain(llm<span style="color:#ff79c6">=</span>llm, prompt<span style="color:#ff79c6">=</span>prompt)
</span></span><span style="display:flex;"><span>result <span style="color:#ff79c6">=</span> chain<span style="color:#ff79c6">.</span>run({<span style="color:#f1fa8c">&#34;input&#34;</span>: <span style="color:#f1fa8c">&#34;test&#34;</span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># NEW (1.x) - Use LCEL</span>
</span></span><span style="display:flex;"><span>chain <span style="color:#ff79c6">=</span> prompt <span style="color:#ff79c6">|</span> llm <span style="color:#ff79c6">|</span> parser
</span></span><span style="display:flex;"><span>result <span style="color:#ff79c6">=</span> chain<span style="color:#ff79c6">.</span>invoke({<span style="color:#f1fa8c">&#34;input&#34;</span>: <span style="color:#f1fa8c">&#34;test&#34;</span>})
</span></span></code></pre></div><p><strong>3. Memory Management</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4"># OLD (0.x)</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> langchain.memory <span style="color:#ff79c6">import</span> ConversationBufferMemory
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>memory <span style="color:#ff79c6">=</span> ConversationBufferMemory()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># NEW (1.x) - Use checkpointer</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> langgraph.checkpoint.postgres <span style="color:#ff79c6">import</span> PostgresSaver
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>checkpointer <span style="color:#ff79c6">=</span> PostgresSaver<span style="color:#ff79c6">.</span>from_conn_string(<span style="color:#f1fa8c">&#34;postgresql://...&#34;</span>)
</span></span></code></pre></div><h3 id="migration-strategy">Migration Strategy</h3>
<p><strong>Phase 1: Assessment (Week 1-2)</strong></p>
<ul>
<li>Inventory existing 0.x implementations</li>
<li>Identify deprecated features in use</li>
<li>Map components to 1.x equivalents</li>
<li>Estimate migration effort</li>
</ul>
<p><strong>Phase 2: Proof of Concept (Week 3-4)</strong></p>
<ul>
<li>Migrate one agent to 1.x</li>
<li>Validate functionality parity</li>
<li>Measure performance differences</li>
<li>Document lessons learned</li>
</ul>
<p><strong>Phase 3: Incremental Migration (Week 5-12)</strong></p>
<ul>
<li>Migrate by component/service</li>
<li>Run 0.x and 1.x in parallel</li>
<li>Gradually shift traffic</li>
<li>Monitor for issues</li>
</ul>
<p><strong>Phase 4: Deprecation (Week 13+)</strong></p>
<ul>
<li>Complete cutover to 1.x</li>
<li>Remove 0.x dependencies</li>
<li>Update documentation</li>
<li>Train team on new patterns</li>
</ul>
<hr>
<h2 id="part-10-real-world-use-cases--architectures">Part 10: Real-World Use Cases &amp; Architectures</h2>
<h3 id="use-case-1-customer-support-agent">Use Case 1: Customer Support Agent</h3>
<p><strong>Requirements:</strong></p>
<ul>
<li>24/7 availability</li>
<li>Access to knowledge base, order history, FAQ</li>
<li>Escalation to humans when needed</li>
<li>Multi-language support</li>
</ul>
<p><strong>Architecture:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">class</span> <span style="color:#50fa7b">CustomerSupportAgent</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">__init__</span>(<span style="font-style:italic">self</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># Tools</span>
</span></span><span style="display:flex;"><span>        @tool
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">search_knowledge_base</span>(query: <span style="color:#8be9fd;font-style:italic">str</span>) <span style="color:#ff79c6">-&gt;</span> <span style="color:#8be9fd;font-style:italic">str</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;&#34;&#34;Search help articles and documentation&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> knowledge_base<span style="color:#ff79c6">.</span>search(query)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        @tool
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">lookup_order</span>(order_id: <span style="color:#8be9fd;font-style:italic">str</span>) <span style="color:#ff79c6">-&gt;</span> <span style="color:#8be9fd;font-style:italic">str</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;&#34;&#34;Get order details and status&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> order_system<span style="color:#ff79c6">.</span>get_order(order_id)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        @tool
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">create_ticket</span>(issue: <span style="color:#8be9fd;font-style:italic">str</span>, priority: <span style="color:#8be9fd;font-style:italic">str</span>) <span style="color:#ff79c6">-&gt;</span> <span style="color:#8be9fd;font-style:italic">str</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;&#34;&#34;Escalate to human support&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> ticketing_system<span style="color:#ff79c6">.</span>create(issue, priority)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># Agent with support-specific middleware</span>
</span></span><span style="display:flex;"><span>        <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>agent <span style="color:#ff79c6">=</span> create_agent(
</span></span><span style="display:flex;"><span>            model<span style="color:#ff79c6">=</span>ChatOpenAI(model<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;gpt-4&#34;</span>),
</span></span><span style="display:flex;"><span>            tools<span style="color:#ff79c6">=</span>[
</span></span><span style="display:flex;"><span>                search_knowledge_base,
</span></span><span style="display:flex;"><span>                lookup_order,
</span></span><span style="display:flex;"><span>                create_ticket
</span></span><span style="display:flex;"><span>            ],
</span></span><span style="display:flex;"><span>            prompt<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;&#34;&#34;You are a helpful customer support agent.
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">            
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">            Guidelines:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">            - Be empathetic and professional
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">            - Search knowledge base before answering
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">            - Look up order details when customer provides order ID
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">            - Escalate complex issues to human support
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">            - Always confirm resolution before ending conversation
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">            &#34;&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>            middleware<span style="color:#ff79c6">=</span>[
</span></span><span style="display:flex;"><span>                LanguageDetectionMiddleware(),
</span></span><span style="display:flex;"><span>                SentimentAnalysisMiddleware(),
</span></span><span style="display:flex;"><span>                EscalationMiddleware(threshold<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0.7</span>),
</span></span><span style="display:flex;"><span>                ResponseTimeMiddleware(max_seconds<span style="color:#ff79c6">=</span><span style="color:#bd93f9">10</span>)
</span></span><span style="display:flex;"><span>            ],
</span></span><span style="display:flex;"><span>            checkpointer<span style="color:#ff79c6">=</span>PostgresSaver<span style="color:#ff79c6">.</span>from_conn_string(os<span style="color:#ff79c6">.</span>getenv(<span style="color:#f1fa8c">&#34;DB_URL&#34;</span>))
</span></span><span style="display:flex;"><span>        )
</span></span></code></pre></div><p><strong>Results:</strong></p>
<ul>
<li>70% of queries resolved without human intervention</li>
<li>Average response time: 3 seconds</li>
<li>Customer satisfaction: 4.2/5</li>
<li>Cost savings: $200K annually</li>
</ul>
<h3 id="use-case-2-data-analysis-assistant">Use Case 2: Data Analysis Assistant</h3>
<p><strong>Requirements:</strong></p>
<ul>
<li>Query SQL databases</li>
<li>Generate visualizations</li>
<li>Perform statistical analysis</li>
<li>Export reports</li>
</ul>
<p><strong>Architecture:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">class</span> <span style="color:#50fa7b">DataAnalysisAgent</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">__init__</span>(<span style="font-style:italic">self</span>):
</span></span><span style="display:flex;"><span>        @tool
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">query_database</span>(sql: <span style="color:#8be9fd;font-style:italic">str</span>) <span style="color:#ff79c6">-&gt;</span> <span style="color:#8be9fd;font-style:italic">str</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;&#34;&#34;Execute SQL query and return results&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6272a4"># Validation and safety checks</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">not</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>_is_safe_query(sql):
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;Error: Query not allowed&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> database<span style="color:#ff79c6">.</span>execute(sql)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        @tool
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">create_visualization</span>(data: <span style="color:#8be9fd;font-style:italic">str</span>, chart_type: <span style="color:#8be9fd;font-style:italic">str</span>) <span style="color:#ff79c6">-&gt;</span> <span style="color:#8be9fd;font-style:italic">str</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;&#34;&#34;Generate chart from data&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> visualization_service<span style="color:#ff79c6">.</span>create(data, chart_type)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        @tool
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">run_statistical_test</span>(data: <span style="color:#8be9fd;font-style:italic">str</span>, test_type: <span style="color:#8be9fd;font-style:italic">str</span>) <span style="color:#ff79c6">-&gt;</span> <span style="color:#8be9fd;font-style:italic">str</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;&#34;&#34;Perform statistical analysis&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> stats_service<span style="color:#ff79c6">.</span>run_test(data, test_type)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>agent <span style="color:#ff79c6">=</span> create_agent(
</span></span><span style="display:flex;"><span>            model<span style="color:#ff79c6">=</span>ChatOpenAI(model<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;gpt-4&#34;</span>),
</span></span><span style="display:flex;"><span>            tools<span style="color:#ff79c6">=</span>[
</span></span><span style="display:flex;"><span>                query_database,
</span></span><span style="display:flex;"><span>                create_visualization,
</span></span><span style="display:flex;"><span>                run_statistical_test
</span></span><span style="display:flex;"><span>            ],
</span></span><span style="display:flex;"><span>            prompt<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;&#34;&#34;You are a data analysis expert.
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">            
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">            When analyzing data:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">            1. Understand the business question
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">            2. Query the appropriate tables
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">            3. Perform relevant analysis
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">            4. Create visualizations
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">            5. Provide actionable insights
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">            &#34;&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>            middleware<span style="color:#ff79c6">=</span>[
</span></span><span style="display:flex;"><span>                SQLValidationMiddleware(),
</span></span><span style="display:flex;"><span>                DataPrivacyMiddleware(),
</span></span><span style="display:flex;"><span>                ResultCachingMiddleware()
</span></span><span style="display:flex;"><span>            ],
</span></span><span style="display:flex;"><span>            checkpointer<span style="color:#ff79c6">=</span>PostgresSaver<span style="color:#ff79c6">.</span>from_conn_string(os<span style="color:#ff79c6">.</span>getenv(<span style="color:#f1fa8c">&#34;DB_URL&#34;</span>))
</span></span><span style="display:flex;"><span>        )
</span></span></code></pre></div><h3 id="use-case-3-document-processing-pipeline">Use Case 3: Document Processing Pipeline</h3>
<p><strong>Requirements:</strong></p>
<ul>
<li>Ingest documents (PDF, Word, emails)</li>
<li>Extract structured data</li>
<li>Classify and route</li>
<li>Store in knowledge base</li>
</ul>
<p><strong>Architecture:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">class</span> <span style="color:#50fa7b">DocumentProcessingPipeline</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">__init__</span>(<span style="font-style:italic">self</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># Specialized agents for different tasks</span>
</span></span><span style="display:flex;"><span>        <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>classifier <span style="color:#ff79c6">=</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>_create_classifier_agent()
</span></span><span style="display:flex;"><span>        <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>extractor <span style="color:#ff79c6">=</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>_create_extractor_agent()
</span></span><span style="display:flex;"><span>        <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>validator <span style="color:#ff79c6">=</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>_create_validator_agent()
</span></span><span style="display:flex;"><span>        <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>orchestrator <span style="color:#ff79c6">=</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>_create_orchestrator_agent()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">_create_extractor_agent</span>(<span style="font-style:italic">self</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;&#34;&#34;Agent for extracting structured data&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> create_agent(
</span></span><span style="display:flex;"><span>            model<span style="color:#ff79c6">=</span>ChatOpenAI(model<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;gpt-4&#34;</span>),
</span></span><span style="display:flex;"><span>            tools<span style="color:#ff79c6">=</span>[ocr_tool, table_extraction_tool],
</span></span><span style="display:flex;"><span>            prompt<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;&#34;&#34;Extract structured information from documents.
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">            
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">            Extract:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">            - Key entities (names, dates, amounts)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">            - Tables and structured data
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">            - Metadata
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">            
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">            Return as JSON.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">process_document</span>(<span style="font-style:italic">self</span>, document_path: <span style="color:#8be9fd;font-style:italic">str</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;&#34;&#34;Process a document through the pipeline&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># 1. Load document</span>
</span></span><span style="display:flex;"><span>        doc <span style="color:#ff79c6">=</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>_load_document(document_path)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># 2. Classify</span>
</span></span><span style="display:flex;"><span>        doc_type <span style="color:#ff79c6">=</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>classifier<span style="color:#ff79c6">.</span>invoke({
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;messages&#34;</span>: [{<span style="color:#f1fa8c">&#34;role&#34;</span>: <span style="color:#f1fa8c">&#34;user&#34;</span>, <span style="color:#f1fa8c">&#34;content&#34;</span>: <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;Classify: </span><span style="color:#f1fa8c">{</span>doc<span style="color:#ff79c6">.</span>text[:<span style="color:#bd93f9">1000</span>]<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>}]
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># 3. Extract based on type</span>
</span></span><span style="display:flex;"><span>        extracted_data <span style="color:#ff79c6">=</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>extractor<span style="color:#ff79c6">.</span>invoke({
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;messages&#34;</span>: [{<span style="color:#f1fa8c">&#34;role&#34;</span>: <span style="color:#f1fa8c">&#34;user&#34;</span>, <span style="color:#f1fa8c">&#34;content&#34;</span>: <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;Extract from </span><span style="color:#f1fa8c">{</span>doc_type<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">: </span><span style="color:#f1fa8c">{</span>doc<span style="color:#ff79c6">.</span>text<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>}]
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># 4. Validate</span>
</span></span><span style="display:flex;"><span>        validated_data <span style="color:#ff79c6">=</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>validator<span style="color:#ff79c6">.</span>invoke({
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;messages&#34;</span>: [{<span style="color:#f1fa8c">&#34;role&#34;</span>: <span style="color:#f1fa8c">&#34;user&#34;</span>, <span style="color:#f1fa8c">&#34;content&#34;</span>: <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;Validate: </span><span style="color:#f1fa8c">{</span>extracted_data<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>}]
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># 5. Store</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="font-style:italic">self</span><span style="color:#ff79c6">.</span>_store_in_knowledge_base(validated_data)
</span></span></code></pre></div><hr>
<h2 id="part-11-decision-framework">Part 11: Decision Framework</h2>
<h3 id="when-to-use-langchain">When to Use LangChain</h3>
<p>✅ <strong>Good Fit:</strong></p>
<ul>
<li>Building agents that need to use tools</li>
<li>RAG applications with multiple data sources</li>
<li>Complex multi-step workflows</li>
<li>Need for provider flexibility</li>
<li>Production deployments with observability needs</li>
</ul>
<p>❌ <strong>Not Ideal:</strong></p>
<ul>
<li>Simple prompt → completion workflows (use SDK directly)</li>
<li>Real-time, ultra-low latency requirements (&lt;100ms)</li>
<li>Highly specialized, custom agent logic</li>
<li>Environments with strict dependency constraints</li>
</ul>
<h3 id="langchain-vs-alternatives">LangChain vs. Alternatives</h3>
<table>
  <thead>
      <tr>
          <th>Feature</th>
          <th>LangChain</th>
          <th>LlamaIndex</th>
          <th>AutoGPT</th>
          <th>Custom</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>Learning Curve</strong></td>
          <td>Medium</td>
          <td>Low</td>
          <td>High</td>
          <td>High</td>
      </tr>
      <tr>
          <td><strong>Flexibility</strong></td>
          <td>High</td>
          <td>Medium</td>
          <td>Low</td>
          <td>Highest</td>
      </tr>
      <tr>
          <td><strong>Production Ready</strong></td>
          <td>Yes (1.x)</td>
          <td>Yes</td>
          <td>No</td>
          <td>Depends</td>
      </tr>
      <tr>
          <td><strong>Provider Support</strong></td>
          <td>1000+</td>
          <td>100+</td>
          <td>Limited</td>
          <td>Manual</td>
      </tr>
      <tr>
          <td><strong>State Management</strong></td>
          <td>Built-in</td>
          <td>Limited</td>
          <td>Built-in</td>
          <td>Manual</td>
      </tr>
      <tr>
          <td><strong>Observability</strong></td>
          <td>Excellent</td>
          <td>Good</td>
          <td>Basic</td>
          <td>Manual</td>
      </tr>
      <tr>
          <td><strong>Best For</strong></td>
          <td>Agents, RAG</td>
          <td>RAG, Search</td>
          <td>Experiments</td>
          <td>Custom Logic</td>
      </tr>
  </tbody>
</table>
<hr>
<h2 id="part-12-best-practices-summary">Part 12: Best Practices Summary</h2>
<h3 id="architecture-principles">Architecture Principles</h3>
<ol>
<li>
<p><strong>Start Simple, Add Complexity Gradually</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4"># Phase 1: Basic agent</span>
</span></span><span style="display:flex;"><span>agent <span style="color:#ff79c6">=</span> create_agent(model<span style="color:#ff79c6">=</span>model, tools<span style="color:#ff79c6">=</span>[search])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Phase 2: Add middleware</span>
</span></span><span style="display:flex;"><span>agent <span style="color:#ff79c6">=</span> create_agent(model<span style="color:#ff79c6">=</span>model, tools<span style="color:#ff79c6">=</span>[search], middleware<span style="color:#ff79c6">=</span>[logging])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Phase 3: Add state management</span>
</span></span><span style="display:flex;"><span>agent <span style="color:#ff79c6">=</span> create_agent(<span style="color:#ff79c6">...</span>, checkpointer<span style="color:#ff79c6">=</span>PostgresSaver(<span style="color:#ff79c6">...</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Phase 4: Multi-agent system</span>
</span></span><span style="display:flex;"><span>supervisor <span style="color:#ff79c6">=</span> create_agent(<span style="color:#ff79c6">...</span>, tools<span style="color:#ff79c6">=</span>[delegate_to_specialist])
</span></span></code></pre></div></li>
<li>
<p><strong>Design for Observability from Day One</strong></p>
<ul>
<li>Enable LangSmith tracing</li>
<li>Add custom metrics</li>
<li>Implement health checks</li>
<li>Log all errors</li>
</ul>
</li>
<li>
<p><strong>Plan for Cost Management</strong></p>
<ul>
<li>Track token usage per user</li>
<li>Implement budgets</li>
<li>Use model routing</li>
<li>Enable caching</li>
</ul>
</li>
<li>
<p><strong>Security is Not Optional</strong></p>
<ul>
<li>Detect and redact PII</li>
<li>Validate all inputs</li>
<li>Audit all operations</li>
<li>Encrypt sensitive data</li>
</ul>
</li>
<li>
<p><strong>Test Thoroughly</strong></p>
<ul>
<li>Unit test agent logic</li>
<li>Integration test full flows</li>
<li>Load test under realistic conditions</li>
<li>Evaluate output quality</li>
</ul>
</li>
</ol>
<h3 id="common-pitfalls-to-avoid">Common Pitfalls to Avoid</h3>
<p>❌ <strong>Don&rsquo;t:</strong> Build without checkpointing
✅ <strong>Do:</strong> Always use a checkpointer in production</p>
<p>❌ <strong>Don&rsquo;t:</strong> Ignore token limits
✅ <strong>Do:</strong> Implement context window management</p>
<p>❌ <strong>Don&rsquo;t:</strong> Skip error handling
✅ <strong>Do:</strong> Handle and log all exceptions gracefully</p>
<p>❌ <strong>Don&rsquo;t:</strong> Use GPT-4 for everything
✅ <strong>Do:</strong> Route to appropriate models based on complexity</p>
<p>❌ <strong>Don&rsquo;t:</strong> Deploy without monitoring
✅ <strong>Do:</strong> Set up comprehensive observability</p>
<hr>
<h2 id="conclusion">Conclusion</h2>
<p>LangChain 1.x represents a maturation of the agent framework ecosystem. For tech leads and solution architects, it offers:</p>
<ul>
<li><strong>Production-ready architecture</strong> with durable execution</li>
<li><strong>Flexible middleware system</strong> for cross-cutting concerns</li>
<li><strong>Comprehensive observability</strong> via LangSmith</li>
<li><strong>Provider agnosticism</strong> for vendor optionality</li>
<li><strong>Clear upgrade path</strong> with stable APIs</li>
</ul>
<p>The framework is well-suited for enterprise deployments where reliability, observability, and maintainability matter as much as functionality.</p>
<h3 id="getting-started-checklist">Getting Started Checklist</h3>
<ol>
<li>
<p><strong>Proof of Concept (Week 1-2)</strong></p>
<ul>
<li><input disabled="" type="checkbox"> Build basic RAG agent</li>
<li><input disabled="" type="checkbox"> Test with your data</li>
<li><input disabled="" type="checkbox"> Measure performance</li>
<li><input disabled="" type="checkbox"> Estimate costs</li>
</ul>
</li>
<li>
<p><strong>Production Planning (Week 3-4)</strong></p>
<ul>
<li><input disabled="" type="checkbox"> Design architecture</li>
<li><input disabled="" type="checkbox"> Select deployment platform</li>
<li><input disabled="" type="checkbox"> Plan observability strategy</li>
<li><input disabled="" type="checkbox"> Define security requirements</li>
</ul>
</li>
<li>
<p><strong>Implementation (Week 5-8)</strong></p>
<ul>
<li><input disabled="" type="checkbox"> Build MVP with core features</li>
<li><input disabled="" type="checkbox"> Add middleware for security</li>
<li><input disabled="" type="checkbox"> Implement monitoring</li>
<li><input disabled="" type="checkbox"> Load test</li>
</ul>
</li>
<li>
<p><strong>Rollout (Week 9-12)</strong></p>
<ul>
<li><input disabled="" type="checkbox"> Deploy to staging</li>
<li><input disabled="" type="checkbox"> Run pilot with limited users</li>
<li><input disabled="" type="checkbox"> Monitor and optimize</li>
<li><input disabled="" type="checkbox"> Scale to production</li>
</ul>
</li>
</ol>
<h3 id="additional-resources">Additional Resources</h3>
<p><strong>Official Documentation:</strong></p>
<ul>
<li>LangChain: <a href="https://python.langchain.com/">https://python.langchain.com/</a></li>
<li>LangGraph: <a href="https://langchain-ai.github.io/langgraph/">https://langchain-ai.github.io/langgraph/</a></li>
<li>LangSmith: <a href="https://smith.langchain.com/">https://smith.langchain.com/</a></li>
</ul>
<p><strong>Community:</strong></p>
<ul>
<li>GitHub: <a href="https://github.com/langchain-ai/langchain">https://github.com/langchain-ai/langchain</a></li>
<li>Discord: <a href="https://discord.gg/langchain">https://discord.gg/langchain</a></li>
<li>Twitter: @LangChainAI</li>
</ul>
<p><strong>Learning:</strong></p>
<ul>
<li>LangChain Academy: <a href="https://academy.langchain.com/">https://academy.langchain.com/</a></li>
<li>Production Best Practices: <a href="https://python.langchain.com/docs/guides/production/">https://python.langchain.com/docs/guides/production/</a></li>
<li>Example Applications: <a href="https://github.com/langchain-ai/langchain/tree/master/templates">https://github.com/langchain-ai/langchain/tree/master/templates</a></li>
</ul>
<hr>
<h2 id="about-this-guide">About This Guide</h2>
<p>This guide was written for technical leaders evaluating and implementing LangChain 1.x in production environments. It reflects real-world architectural patterns and operational practices from enterprise deployments.</p>
<p><strong>Last Updated:</strong> December 2025<br>
<strong>LangChain Version:</strong> 1.x<br>
<strong>Target Audience:</strong> Tech Leads, Solution Architects, Engineering Managers</p>
<p>For questions, corrections, or contributions, please reach out through the LangChain community channels.</p>
<hr>
<p><strong>Ready to build production AI agents?</strong> Start with the simple examples in this guide, then progressively add the production features your use case requires. The modular architecture makes it easy to grow from prototype to enterprise-grade system.</p>
<p>Happy building! 🚀</p>

            
             
            




            
            </div>
            
            

<div class="
    col-lg-3 col-lg-offset-0
    col-md-3 col-md-offset-0
    col-sm-12
    col-xs-12
    sidebar-container
">
    
	
    <section class="visible-md visible-lg">
	
        <div class="short-about">
            
            <a href="/about">
               <img src="/img/20190713213835-3.jpg" alt="avatar" style="cursor: pointer" />
            </a>
            
            
                <p>Senior Software Engineer, Open source enthusiasts, PMP, Scrum master</p>
            
           
           <ul class="list-inline">
               
               <li>
                   <a href="mailto:akjamie.zhang@outlook.com">
                      <span class="fa-stack fa-lg">
                          <i class="fa fa-circle fa-stack-2x"></i>
                          <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                      </span>
                   </a>
               </li>
               
               
               
               
               
               
               <li>
                   <a target="_blank" href="/img/wechat-qrcode.png">
                       <span class="fa-stack fa-lg">
                           <i class="fas fa-circle fa-stack-2x"></i>
                           <i class="fab fa-weixin fa-stack-1x fa-inverse"></i>
                       </span>
                   </a>
               </li>
               
               
               <li>
                   <a target="_blank" href="https://github.com/akjamie">
                       <span class="fa-stack fa-lg">
                           <i class="fas fa-circle fa-stack-2x"></i>
                           <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                       </span>
                   </a>
               </li>
               
               
               
               
               <li>
                   <a target="_blank" href="https://www.linkedin.com/in/jamie-zhang">
                       <span class="fa-stack fa-lg">
                           <i class="fas fa-circle fa-stack-2x"></i>
                           <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                       </span>
                   </a>
               </li>
               
               
               
            
            
               
               
               
               
                </ul>
            </div>
    </section>
	
    
    
    
    
    <section>
        <hr class="hidden-sm hidden-xs">
        <h5>FEATURED TAGS</h5>
        <div class="tags">
            
            
               
            
               
            
               
            
               
                    <a href="/tags/aws" title="aws">
                        aws
                    </a>
               
            
               
            
               
            
               
            
               
            
               
            
               
            
               
            
               
                    <a href="/tags/docker" title="docker">
                        docker
                    </a>
               
            
               
            
               
            
               
            
               
            
               
            
               
                    <a href="/tags/k8s" title="k8s">
                        k8s
                    </a>
               
            
               
                    <a href="/tags/kubernetes" title="kubernetes">
                        kubernetes
                    </a>
               
            
               
            
               
            
               
                    <a href="/tags/llm" title="llm">
                        llm
                    </a>
               
            
               
            
               
            
               
            
               
            
               
                    <a href="/tags/nosql" title="nosql">
                        nosql
                    </a>
               
            
               
            
               
                    <a href="/tags/python" title="python">
                        python
                    </a>
               
            
               
                    <a href="/tags/redis" title="redis">
                        redis
                    </a>
               
            
               
            
               
            
               
                    <a href="/tags/spring" title="spring">
                        spring
                    </a>
               
            
               
            
               
            
               
                    <a href="/tags/spring-cloud" title="spring cloud">
                        spring cloud
                    </a>
               
            
               
            
               
            
               
                    <a href="/tags/transaction-management" title="transaction management">
                        transaction management
                    </a>
               
            
               
                    <a href="/tags/transformer" title="transformer">
                        transformer
                    </a>
               
            
               
            
               
                    <a href="/tags/vault" title="vault">
                        vault
                    </a>
               
            
               
            
        </div>
    </section>
    

    
    
    <section>
        <hr class="hidden-sm hidden-xs">
        <h5>FRIENDS</h5>
        <ul class="list-inline">
            
        </ul>
    </section>
    
    
    
</div>

        </div>
    </div>
</article>




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    
                    <li>
                        <a href="mailto:akjamie.zhang@outlook.com">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		           
                    
                    
                    
                    

		            
                    
                    <li>
                        <a target="_blank" href="/img/wechat-qrcode.png">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-weixin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		            
                    
                    <li>
                        <a target="_blank" href="https://github.com/akjamie">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		            
                    
                    
                    
                    <li>
                        <a target="_blank" href="https://www.linkedin.com/in/jamie-zhang">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		           
                    
                    
                    
                    
                    
                    
            
            
            
           
                   <li>
                       <a href='' rel="alternate" type="application/rss+xml" title="Jamie&#39;s Blog" >
                           <span class="fa-stack fa-lg">
                               <i class="fas fa-circle fa-stack-2x"></i>
                               <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
                           </span>
                       </a>
                   </li>
            
             </ul>
		<p class="copyright text-muted">
                    Copyright &copy; Jamie&#39;s Blog 2025
                    
                </p>
            </div>
        </div>
    </div>
</footer>




<script>
    function loadAsync(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>






<script>
    
    if($('#tag_cloud').length !== 0){
        loadAsync("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script>
    loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>






<script type="text/javascript">
    function generateCatalog(selector) {

        
        
        
        
            _containerSelector = 'div.post-container'
        

        
        var P = $(_containerSelector), a, n, t, l, i, c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        
        $(selector).html('')

        
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#" + $(this).prop('id');
            t = $(this).text();
            c = $('<a href="' + i + '" rel="nofollow" title="' + t + '">' + t + '</a>');
            l = $('<li class="' + n + '_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    
    $(".catalog-toggle").click((function (e) {
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    


    loadAsync("\/js\/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>







</body>
</html>
